<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Financeiro Pro</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { background-color: #111; color: white; font-family: sans-serif; text-align: center; }
        
        select, input {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            background-color: #222;
            color: white;
            border: 1px solid #444;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        #grafico { width: 95%; height: 600px; margin: 0 auto; }
        
        /* Ajuste para telas menores */
        @media (max-width: 768px) {
            #grafico { height: 400px; }
        }
    </style>
</head>
<body>

    <h1>Monitor de Mercado</h1>

    <select id="seletor-ativo" onchange="mudouAtivo()">
        <optgroup label="Criptomoedas">
            <option value="BTC-USD" selected>Bitcoin (BTC)</option>
            <option value="ETH-USD">Ethereum (ETH)</option>
            <option value="SOL-USD">Solana (SOL)</option>
            <option value="BNB-USD">Binance Coin (BNB)</option>
            <option value="XRP-USD">XRP (XRP)</option>
            <option value="ADA-USD">Cardano (ADA)</option>
            <option value="DOGE-USD">Dogecoin (DOGE)</option>
            <option value="AVAX-USD">Avalanche (AVAX)</option>
            <option value="TRX-USD">Tron (TRX)</option>
            <option value="DOT-USD">Polkadot (DOT)</option>
            <option value="LINK-USD">Chainlink (LINK)</option>
            <option value="MATIC-USD">Polygon (MATIC)</option>
            <option value="LTC-USD">Litecoin (LTC)</option>
            <option value="BCH-USD">Bitcoin Cash (BCH)</option>
            <option value="UNI-USD">Uniswap (UNI)</option>
            <option value="ATOM-USD">Cosmos (ATOM)</option>
            <option value="XLM-USD">Stellar (XLM)</option>
            <option value="ETC-USD">Ethereum Classic (ETC)</option>
            <option value="FIL-USD">Filecoin (FIL)</option>
            <option value="HBAR-USD">Hedera (HBAR)</option>
            <option value="APT-USD">Aptos (APT)</option>
            <option value="NEAR-USD">Near Protocol (NEAR)</option>
            <option value="VET-USD">VeChain (VET)</option>
            <option value="QNT-USD">Quant (QNT)</option>
            <option value="MKR-USD">Maker (MKR)</option>
            <option value="AAVE-USD">Aave (AAVE)</option>
            <option value="ALGO-USD">Algorand (ALGO)</option>
            <option value="GRT-USD">The Graph (GRT)</option>
            <option value="FTM-USD">Fantom (FTM)</option>
            <option value="SAND-USD">The Sandbox (SAND)</option>
            <option value="EOS-USD">EOS (EOS)</option>
            <option value="MANA-USD">Decentraland (MANA)</option>
        </optgroup>
        <optgroup label="Ações Brasil (Top 40)">
            <option value="VALE3.SA">Vale (VALE3)</option>
            <option value="PETR4.SA">Petrobras PN (PETR4)</option>
            <option value="ITUB4.SA">Itaú Unibanco (ITUB4)</option>
            <option value="BBDC4.SA">Bradesco PN (BBDC4)</option>
            <option value="BBAS3.SA">Banco do Brasil (BBAS3)</option>
            <option value="PETR3.SA">Petrobras ON (PETR3)</option>
            <option value="ABEV3.SA">Ambev (ABEV3)</option>
            <option value="WEGE3.SA">WEG (WEGE3)</option>
            <option value="RENT3.SA">Localiza (RENT3)</option>
            <option value="BPAC11.SA">BTG Pactual (BPAC11)</option>
            <option value="SUZB3.SA">Suzano (SUZB3)</option>
            <option value="ITSA4.SA">Itaúsa (ITSA4)</option>
            <option value="HAPV3.SA">Hapvida (HAPV3)</option>
            <option value="RDOR3.SA">Rede D'Or (RDOR3)</option>
            <option value="JBSS3.SA">JBS (JBSS3)</option>
            <option value="B3SA3.SA">B3 (B3SA3)</option>
            <option value="GGBR4.SA">Gerdau (GGBR4)</option>
            <option value="RADL3.SA">Raia Drogasil (RADL3)</option>
            <option value="PRIO3.SA">Prio (PRIO3)</option>
            <option value="RAIL3.SA">Rumo (RAIL3)</option>
            <option value="VBBR3.SA">Vibra (VBBR3)</option>
            <option value="ELET3.SA">Eletrobras (ELET3)</option>
            <option value="UGPA3.SA">Ultrapar (UGPA3)</option>
            <option value="CSAN3.SA">Cosan (CSAN3)</option>
            <option value="BBSE3.SA">BB Seguridade (BBSE3)</option>
            <option value="LREN3.SA">Lojas Renner (LREN3)</option>
            <option value="VIVT3.SA">Vivo (VIVT3)</option>
            <option value="EQTL3.SA">Equatorial (EQTL3)</option>
            <option value="SBSP3.SA">Sabesp (SBSP3)</option>
            <option value="CMIG4.SA">Cemig (CMIG4)</option>
            <option value="CPLE6.SA">Copel (CPLE6)</option>
            <option value="EMBR3.SA">Embraer (EMBR3)</option>
            <option value="TIMS3.SA">TIM (TIMS3)</option>
            <option value="CCRO3.SA">CCR (CCRO3)</option>
            <option value="ASAI3.SA">Assaí (ASAI3)</option>
            <option value="HYPE3.SA">Hypera (HYPE3)</option>
            <option value="TOTS3.SA">Totvs (TOTS3)</option>
            <option value="CSNA3.SA">CSN (CSNA3)</option>
            <option value="MGLU3.SA">Magalu (MGLU3)</option>
            <option value="VIIA3.SA">Via (VIIA3)</option>
        </optgroup>
        <optgroup label="Ações EUA (Top 40)">
            <option value="AAPL">Apple (AAPL)</option>
            <option value="MSFT">Microsoft (MSFT)</option>
            <option value="GOOGL">Alphabet A (GOOGL)</option>
            <option value="AMZN">Amazon (AMZN)</option>
            <option value="NVDA">NVIDIA (NVDA)</option>
            <option value="TSLA">Tesla (TSLA)</option>
            <option value="META">Meta (META)</option>
            <option value="BRK-B">Berkshire Hathaway (BRK-B)</option>
            <option value="LLY">Eli Lilly (LLY)</option>
            <option value="V">Visa (V)</option>
            <option value="UNH">UnitedHealth (UNH)</option>
            <option value="XOM">Exxon Mobil (XOM)</option>
            <option value="JNJ">Johnson & Johnson (JNJ)</option>
            <option value="JPM">JPMorgan Chase (JPM)</option>
            <option value="PG">Procter & Gamble (PG)</option>
            <option value="MA">Mastercard (MA)</option>
            <option value="AVGO">Broadcom (AVGO)</option>
            <option value="HD">Home Depot (HD)</option>
            <option value="CVX">Chevron (CVX)</option>
            <option value="MRK">Merck (MRK)</option>
            <option value="ABBV">AbbVie (ABBV)</option>
            <option value="PEP">PepsiCo (PEP)</option>
            <option value="KO">Coca-Cola (KO)</option>
            <option value="COST">Costco (COST)</option>
            <option value="ADBE">Adobe (ADBE)</option>
            <option value="WMT">Walmart (WMT)</option>
            <option value="MCD">McDonald's (MCD)</option>
            <option value="CSCO">Cisco (CSCO)</option>
            <option value="CRM">Salesforce (CRM)</option>
            <option value="PFE">Pfizer (PFE)</option>
            <option value="TMO">Thermo Fisher (TMO)</option>
            <option value="BAC">Bank of America (BAC)</option>
            <option value="NFLX">Netflix (NFLX)</option>
            <option value="ABT">Abbott (ABT)</option>
            <option value="DHR">Danaher (DHR)</option>
            <option value="CMCSA">Comcast (CMCSA)</option>
            <option value="AMD">AMD (AMD)</option>
            <option value="NKE">Nike (NKE)</option>
            <option value="DIS">Disney (DIS)</option>
            <option value="INTC">Intel (INTC)</option>
        </optgroup>
        <optgroup label="Índices Globais">
            <option value="^BVSP">Ibovespa</option>
            <option value="^GSPC">S&P 500</option>
            <option value="^IXIC">Nasdaq Composite</option>
            <option value="^DJI">Dow Jones Industrial</option>
            <option value="^FTSE">FTSE 100</option>
            <option value="^GDAXI">DAX Performance</option>
            <option value="^FCHI">CAC 40</option>
            <option value="^N225">Nikkei 225</option>
            <option value="^HSI">Hang Seng</option>
            <option value="GC=F">Ouro (Gold)</option>
            <option value="CL=F">Petróleo (Crude Oil)</option>
            <option value="SI=F">Prata (Silver)</option>
            <option value="HG=F">Cobre (Copper)</option>
            <option value="EURUSD=X">EUR/USD</option>
            <option value="GBPUSD=X">GBP/USD</option>
            <option value="JPY=X">USD/JPY</option>
            <option value="BRL=X">USD/BRL</option>
        </optgroup>
    </select>

    <select id="seletor-periodo" onchange="mudouAtivo()">
        <option value="1d">1 Dia</option>
        <option value="5d">5 Dias</option>
        <option value="1mo" selected>1 Mês</option>
        <option value="3mo">3 Meses</option>
        <option value="6mo">6 Meses</option>
        <option value="1y">1 Ano</option>
        <option value="2y">2 Anos</option>
        <option value="5y">5 Anos</option>
        <option value="max">Máximo</option>
    </select>

    <select id="seletor-intervalo" onchange="mudouAtivo()">
        <option value="1m">1 Minuto</option>
        <option value="5m">5 Minutos</option>
        <option value="15m">15 Minutos</option>
        <option value="30m">30 Minutos</option>
        <option value="1h" selected>1 Hora</option>
        <option value="1d">1 Dia</option>
        <option value="1wk">1 Semana</option>
        <option value="1mo">1 Mês</option>
    </select>

    <input type="number" id="input-ma" value="14" min="1" max="200" onchange="mudouAtivo()" style="width: 60px;" title="Período da Média Móvel">

    <h2 id="titulo-ativo">BTC-USD</h2>
    <h3 id="preco" style="color: cyan;">Carregando...</h3>
    
    <!-- Seletor de Categoria do Heatmap -->
    <div style="margin-bottom: 5px;">
        <label for="heatmap-category" style="margin-right: 10px;">Heatmap:</label>
        <select id="heatmap-category" onchange="atualizarHeatmap()">
            <option value="cripto" selected>Criptomoedas</option>
            <option value="br">Ações Brasil (Top 40)</option>
            <option value="us">Ações EUA (Top 40)</option>
            <option value="indices">Índices Globais</option>
        </select>
    </div>

    <!-- Container do Heatmap -->
    <div id="heatmap" style="width: 95%; height: 400px; margin: 0 auto; margin-bottom: 20px;"></div>

    <div id="grafico"></div>

    <script>
        // Variável global para guardar o layout e evitar piscadas bruscas
        let layoutAtual = null;

        function mudouAtivo(tickerOpcional) {
            if (tickerOpcional) {
                const seletor = document.getElementById('seletor-ativo');
                // Verifica se o ticker existe no select
                let existe = false;
                for (let i = 0; i < seletor.options.length; i++) {
                    if (seletor.options[i].value === tickerOpcional) {
                        seletor.selectedIndex = i;
                        existe = true;
                        break;
                    }
                }
                if (!existe) {
                    // Se não existe, adiciona temporariamente
                    const option = document.createElement('option');
                    option.value = tickerOpcional;
                    option.text = tickerOpcional;
                    seletor.add(option);
                    seletor.value = tickerOpcional;
                }
            }
            document.getElementById('titulo-ativo').innerText = "Carregando...";
            atualizarGrafico();
        }

        async function atualizarHeatmap() {
            try {
                const categoria = document.getElementById('heatmap-category').value;
                // Mostra loading no titulo do heatmap (opcional, mas visualmente bom)
                // Plotly.relayout('heatmap', {title: 'Carregando...'});

                const response = await fetch(`http://127.0.0.1:5000/api/heatmap?type=${categoria}`);
                const dados = await response.json();

                const symbols = dados.map(d => d.symbol);
                const labels = dados.map(d => d.label);
                const changes = dados.map(d => d.change);
                const parents = dados.map(d => ""); 

                // Cores baseadas na variação
                const colors = changes.map(c => c >= 0 ? '#00cc00' : '#cc0000');

                const data = [{
                    type: "treemap",
                    labels: labels,
                    parents: parents,
                    values: Array(dados.length).fill(1), 
                    textinfo: "label+text",
                    marker: {colors: colors},
                    ids: symbols 
                }];

                const layout = {
                    title: `Heatmap 24h (%) - ${categoria.toUpperCase()}`,
                    margin: {t: 30, l: 10, r: 10, b: 10},
                    paper_bgcolor: '#111',
                    font: {color: 'white'}
                };

                Plotly.react('heatmap', data, layout);

                // Adiciona evento de clique
                const heatmapDiv = document.getElementById('heatmap');
                heatmapDiv.on('plotly_click', function(data){
                    const ticker = data.points[0].id;
                    if (ticker) {
                        mudouAtivo(ticker);
                    }
                });

            } catch (erro) {
                console.error("Erro no heatmap:", erro);
            }
        }

        async function atualizarGrafico() {
            try {
                // 1. AQUI ESTÁ A CORREÇÃO DO "RESET":
                // Toda vez que essa função roda (seja pelo clique ou pelo timer),
                // ela lê o que está selecionado NAQUELE MOMENTO na caixinha.
                const seletor = document.getElementById('seletor-ativo');
                const ativoSelecionado = seletor.value; 
                const nomeAtivo = seletor.options[seletor.selectedIndex].text;

                const periodo = document.getElementById('seletor-periodo').value;
                const intervalo = document.getElementById('seletor-intervalo').value;
                const maPeriod = document.getElementById('input-ma').value;

                // Chama o backend
                const response = await fetch(`http://127.0.0.1:5000/api/dados?ticker=${ativoSelecionado}&period=${periodo}&interval=${intervalo}&ma_period=${maPeriod}`);
                if (!response.ok) throw new Error("Erro na API");
                const dados = await response.json();

                // Atualiza textos da tela
                document.getElementById('titulo-ativo').innerText = nomeAtivo;
                document.getElementById('preco').innerText = "R$ " + dados.preco_atual;

                // --- CONFIGURAÇÃO DOS CANDLES ---
                const candles = {
                    x: dados.datas,
                    close: dados.close,
                    decreasing: {line: {color: '#ff3333', width: 1}},
                    high: dados.high,
                    increasing: {line: {color: '#00ff00', width: 1}},
                    low: dados.low,
                    open: dados.open,
                    type: 'candlestick',
                    name: 'Preço'
                };

                // --- CONFIGURAÇÃO DA MÉDIA ---
                const mediaMovel = {
                    x: dados.datas,
                    y: dados.ma,
                    type: 'scatter',
                    mode: 'lines',
                    line: {color: 'yellow', width: 1.5},
                    name: dados.ma_label
                };

                // --- AQUI ESTÁ A CORREÇÃO VISUAL (TIRA OS BURANCOS) ---
                const layout = {
                    dragmode: 'pan', // Permite arrastar o gráfico
                    margin: {r: 40, t: 30, b: 50, l: 60},
                    showlegend: true,
                    legend: {x: 0, y: 1, font: {color: 'white'}},
                    
                    xaxis: {
                        type: 'category',  // <--- ESSA LINHA MÁGICA REMOVE OS ESPAÇOS VAZIOS
                        rangeslider: {visible: false}, 
                        gridcolor: '#333',
                        nticks: 10, // Mostra apenas +- 10 datas para não poluir o eixo X
                        tickangle: -20 // Inclina a data para caber melhor
                    },
                    
                    yaxis: {
                        gridcolor: '#333',
                        autorange: true,
                        fixedrange: false // Permite dar zoom vertical
                    },
                    paper_bgcolor: '#111',
                    plot_bgcolor: '#111',
                    font: {color: '#ddd'}
                };

                // Plotly.react é mais eficiente para atualizar dados sem recriar o gráfico do zero
                Plotly.react('grafico', [candles, mediaMovel], layout);

            } catch (erro) {
                console.error("Erro:", erro);
            }
        }

        // 1. Roda assim que abre a página
        atualizarGrafico();
        atualizarHeatmap();

        // 2. Roda a cada 60 segundos AUTOMATICAMENTE
        setInterval(atualizarGrafico, 60000);
        setInterval(atualizarHeatmap, 60000);
    </script>
</body>
</html>