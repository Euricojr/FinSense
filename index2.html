<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSense - An√°lise de Mercado</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-locale-pt-br-latest.js"></script>
    <script src="static/js/translations.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode (Default) */
            --bg-main: #f0f2f5;
            --bg-panel: #f8f9fa;
            --text-main: #1a1a1a;
            --text-muted: #666666;
            --accent-primary: #0056b3;
            --accent-hover: #004494;
            --border-color: #e0e0e0;
            --success-green: #008000;
            --danger-red: #d32f2f;
            --hero-bg: #0a192f;
            --chart-bg: #ffffff;
            --chart-grid: #e0e0e0;
        }

        [data-theme="dark"] {
            /* Dark Mode */
            --bg-main: #0a192f;
            --bg-panel: #112240;
            --text-main: #e6f1ff;
            --text-muted: #8892b0;
            --accent-primary: #4da3ff;
            --accent-hover: #2d89ef;
            --border-color: #233554;
            --success-green: #64ffda;
            --danger-red: #ff5f56;
            --hero-bg: #020c1b;
            --chart-bg: #112240;
            --chart-grid: #233554;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-panel);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-hover);
        }

        /* --- Header --- */
        header {
            background-color: transparent;
            padding: 0 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: absolute;
            top: 0;
            width: 100%;
            z-index: 1000;
        }

        .logo {
            font-weight: 700;
            font-size: 22px;
            color: white;
        }

        nav {
            display: flex;
            align-items: center;
        }

        nav a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            margin-left: 20px;
            font-weight: 500;
            transition: color 0.2s;
            font-size: 16px;
        }

        nav a:hover {
            color: white;
        }

        .nav-btn-drop {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-family: inherit;
            font-size: 16px;
            font-weight: 500;
            margin-left: 30px;
            cursor: pointer;
            padding: 10px 0;
        }

        .nav-btn-drop:hover {
            color: white;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 16px;
            margin-left: 12px;
            width: 50px; /* Slim Pill Width */
            height: 32px; /* Slim Pill Height */
            border-radius: 16px; /* Pill Radius */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .theme-toggle:active {
            transform: translateY(0);
        }

        .btn-logout {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            margin-left: 20px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .btn-logout:hover {
            color: #ff5f56; /* Danger red */
            background: rgba(255, 95, 86, 0.1);
        }

        /* --- Dropdown Nav --- */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-panel);
            min-width: 220px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            border-radius: 8px;
            top: 100%;
            left: 0;
        }

        .dropdown-content a {
            color: var(--text-main);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            white-space: nowrap;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: var(--bg-main);
            color: var(--accent-primary);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .nav-btn-drop {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-family: inherit;
            font-size: 16px;
            font-weight: 500;
            margin-left: 0;
            cursor: pointer;
            padding: 10px 0;
        }

        .nav-btn-drop:hover {
            color: white;
        }

        .btn-logout {
            margin-left: 10px;
            padding: 6px 16px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background-color: rgba(220, 53, 69, 0.15);
            border-color: #ff5f56;
            color: #ff5f56;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }


        /* --- Hero Section --- */
        .hero {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: linear-gradient(135deg, #0a192f 0%, #112240 100%);
            color: white;
            padding: 0 20px;
            position: relative;
            overflow: hidden;
            /* Ensure particles don't overflow */
        }

        #hero-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            /* Behind content but above background */
            pointer-events: none;
            /* Allow clicks to pass through */
        }

        .hero h1,
        .hero p,
        .hero .cta-button {
            position: relative;
            z-index: 2;
            /* Ensure content is above particles */
        }

        .hero h1 {
            font-size: 56px;
            font-weight: 800;
            margin-bottom: 20px;
            max-width: 900px;
            line-height: 1.1;
        }

        .text-blue-highlight {
            color: #4da3ff; /* Bright blue match */
        }

        .hero p {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 50px;
            max-width: 700px;
        }

        .cta-button {
            background-color: var(--accent-primary);
            color: white;
            padding: 18px 50px;
            border-radius: 40px;
            text-decoration: none;
            font-weight: 600;
            font-size: 18px;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0, 86, 179, 0.4);
        }

        .cta-button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0, 86, 179, 0.6);
        }

        .scroll-indicator {
            position: absolute;
            bottom: 30px;
            font-size: 24px;
            animation: bounce 2s infinite;
            color: rgba(255, 255, 255, 0.5);
            z-index: 2;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        /* --- Dashboard Section --- */
        #dashboard {
            height: 100vh;
            /* Full viewport height */
            display: flex;
            flex-direction: column;
            background-color: var(--bg-main);
            overflow: hidden;
            /* Prevent body scroll within dashboard */
        }

        .dashboard-header {
            padding: 10px 20px;
            background-color: var(--hero-bg);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            height: 50px;
            /* Fixed height */
            transition: background-color 0.3s;
        }

        .dashboard-title {
            font-size: 18px;
            font-weight: 700;
        }

        .main-container {
            display: flex;
            flex: 1;
            padding: 10px;
            gap: 10px;
            background-color: var(--bg-main);
            height: calc(100vh - 50px);
            /* Fill remaining height */
            width: 100%;
            max-width: 100%;
            /* Full width */
            margin: 0;
            box-sizing: border-box;
        }

        /* --- Chart Section (Left) --- */
        .chart-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-panel);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            height: 100%;
            /* Fill container */
            overflow: hidden;
        }

        /* --- Chart Section (Left) --- */
        .chart-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-panel);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            height: 100%;
            /* Fill container */
            overflow: hidden;
        }

        /* --- Market Section --- */
        #mercado {
            min-height: 100vh;
            height: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-main);
            padding-top: 70px;
            /* Header space */
            padding-bottom: 40px;
        }

        .market-container {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .heatmap-container {
            background-color: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- Market Grid Styles --- */
        .market-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            padding: 5px;
        }

        .market-card {
            background-color: var(--bg-main);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 75px;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: default;
            color: #ffffff !important;
            /* Force white text */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .market-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Brighter, more readable colors */
        .market-card.positive {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 1px solid #059669;
        }

        .market-card.negative {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: 1px solid #dc2626;
        }

        .card-symbol {
            font-size: 13px;
            font-weight: 800;
            margin-bottom: 2px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .card-price {
            font-size: 13px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .card-change {
            font-size: 12px;
            font-weight: 700;
            margin-top: auto;
            opacity: 1;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .heatmap-loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        [data-theme="dark"] .heatmap-loading {
            background-color: rgba(17, 34, 64, 0.8);
        }

        .heatmap-loading.active {
            opacity: 1;
            pointer-events: all;
        }

        .heatmap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-main);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-title-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chart-title {
            font-size: 18px; /* Reduced from 24px */
            font-weight: 700;
            color: var(--text-main);
            letter-spacing: -0.5px;
        }

        .price-display {
            font-size: 18px; /* Reduced from 24px */
            font-weight: 500;
            color: var(--accent-primary);
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            /* margin-left: auto; Removed for centering search */
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px; /* Slightly more gap */
            align-items: flex-start; /* Align labels to start */
        }

        .control-label {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        select,
        input[type="number"] {
            background-color: var(--bg-panel);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 6px 12px; /* Increased padding */
            border-radius: 8px; /* Softer corners */
            font-family: 'Manrope', sans-serif; /* Explicit font */
            font-size: 13px;
            font-weight: 500;
            outline: none;
            cursor: pointer;
            height: 36px; /* Taller touch target */
            text-align: left; /* Align text left for natural read */
            appearance: none; /* Remove default arrow for custom styling if needed, keeping simple for now */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            padding-right: 30px; /* Space for arrow */
            transition: all 0.2s;
        }

        select:hover,
        input:hover {
            border-color: var(--accent-primary);
            background-color: var(--bg-main);
        }
        
        select:focus {
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
            border-color: var(--accent-primary);
        }

        select:hover,
        input:hover {
            border-color: #bbb;
        }

        /* --- Sidebar REMOVED --- */
        /* Search Bar Styles */
        .search-container {
            position: relative;
            width: 300px;
            margin: 0 auto; /* Center the search box */
        }

        #asset-search {
            background-color: var(--bg-main);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 6px;
            font-family: inherit;
            font-size: 14px;
            width: 100%;
            outline: none;
            transition: border-color 0.2s;
        }

        #asset-search:focus {
            border-color: var(--accent-primary);
        }

        #suggestions {
            position: absolute;
            top: 105%;
            left: 0;
            width: 100%;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            list-style: none;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            padding: 0;
            margin: 0;
        }
        
        #suggestions li {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            color: var(--text-main);
            display: flex;
            justify-content: space-between;
        }
        
        #suggestions li:hover {
            background-color: var(--bg-main);
        }

        @media (max-width: 768px) {
            .search-container {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-panel);
        }

        /* Styled Selector */
        .custom-select {
            width: 100%;
            padding: 10px 15px;
            background-color: var(--bg-main);
            color: var(--text-main);
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 15px center;
            background-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            height: auto;
            /* Override global select height */
        }

        .custom-select:hover {
            border-color: var(--accent-primary);
            background-color: var(--bg-panel);
        }

        .custom-select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.1);
        }

        .asset-list {
            flex: 1;
            overflow-y: auto;
            max-height: 800px;
        }

        .asset-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .asset-item:hover {
            background-color: var(--bg-main);
        }

        .asset-item.active {
            background-color: rgba(0, 86, 179, 0.1);
            border-left: 4px solid var(--accent-primary);
        }

        .asset-info {
            display: flex;
            flex-direction: column;
        }

        .asset-symbol {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-main);
        }

        .asset-name {
            font-size: 12px;
            color: var(--text-muted);
        }

        .asset-price-info {
            text-align: right;
        }

        .asset-price {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-main);
        }

        .asset-change {
            font-size: 12px;
            font-weight: 600;
        }

        .positive {
            color: var(--success-green);
        }

        .negative {
            color: var(--danger-red);
        }

        /* --- Spinner --- */
        .spinner {
            border: 3px solid rgba(0, 86, 179, 0.1);
            border-left-color: var(--accent-primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .spinner.active {
            opacity: 1;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Checkbox Style */
        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 1px solid var(--text-muted);
            border-radius: 4px;
            background-color: var(--bg-panel);
            cursor: pointer;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input[type="checkbox"]:checked {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        input[type="checkbox"]:checked::after {
            content: '‚úî';
            font-size: 12px;
            color: white;
        }

        /* --- Multiselect Dropdown --- */
        .multiselect-container {
            position: relative;
            display: inline-block;
            width: 200px;
        }

        .multiselect-btn {
            background-color: var(--bg-panel);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            width: 100%;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multiselect-btn::after {
            content: '‚ñº';
            font-size: 10px;
            margin-left: 10px;
        }

        .multiselect-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-top: 5px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 5px 0;
        }

        .multiselect-menu.active {
            display: block;
        }

        .multiselect-item {
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .multiselect-item:hover {
            background-color: var(--bg-main);
        }

        .multiselect-item label {
            cursor: pointer;
            font-size: 13px;
            color: var(--text-main);
            flex: 1;
            white-space: nowrap;
        }

        /* --- Market Movers Section --- */
        .market-movers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .mover-card {
            background-color: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .mover-card h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .mover-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .mover-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .mover-item:last-child {
            border-bottom: none;
        }

        .mover-symbol {
            font-weight: 600;
            color: var(--text-main);
        }

        .mover-price {
            color: var(--text-muted);
            font-size: 13px;
            margin-right: 15px;
        }

        .mover-change {
            font-weight: 600;
            font-size: 13px;
        }

        .change-positive {
            color: #00c853;
        }

        .change-negative {
            color: #d32f2f;
        }



        /* New Styles for Destaques Section */
        #destaques {
            padding: 40px;
            /* Increased padding overall, effectively more separation */
            margin-top: 30px;
            /* Added explicit margin for "descer mais um pouco" */
        }

        .mover-card {
            background-color: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .destaques-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .destaques-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .mover-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }


        .mover-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .mover-item:last-child {
            border-bottom: none;
        }

        .mover-symbol {
            font-weight: 600;
            color: var(--text-main);
        }

        .mover-price {
            color: var(--text-muted);
            font-size: 13px;
            margin-right: 15px;
        }

        .mover-change {
            font-weight: 600;
            font-size: 13px;
        }

        .change-positive {
            color: #00c853;
        }

        .change-negative {
            color: #d32f2f;
        }
        /* --- Mobile Responsive Styles --- */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            z-index: 1002;
        }
        
        .mobile-menu-btn span {
            display: block;
            width: 25px;
            height: 3px;
            margin: 5px 0;
            background-color: white;
            transition: 0.3s;
        }

        @media (max-width: 768px) {
            /* Header adjustments */
            header {
                height: 70px; /* Fixed small height */
                padding: 0 20px;
                flex-direction: row; /* Horizontal layout */
                justify-content: space-between;
                align-items: center;
                background-color: var(--hero-bg);
            }

            .logo img {
                height: 110px !important; 
                margin-top: -30px !important;
                margin-bottom: -30px !important;
                margin-left: -20px !important;
            }
            
            .mobile-menu-btn {
                display: block;
            }

            nav {
                display: none; /* Hidden by default */
                position: absolute;
                top: 70px;
                left: 0;
                width: 100%;
                background-color: var(--hero-bg);
                flex-direction: column;
                align-items: center;
                padding: 20px 0;
                box-shadow: 0 10px 20px rgba(0,0,0,0.5);
                z-index: 999;
                border-top: 1px solid rgba(255,255,255,0.1);
            }
            
            nav.active {
                display: flex;
                flex-direction: column; /* Ensure vertical stack */
                align-items: center; /* Center items horizontally */
                justify-content: center;
            }

            nav a, .nav-btn-drop {
                margin: 10px 0;
                font-size: 16px; 
                display: block;
                width: 100%;
                text-align: center; /* Enforce text centering */
            }

            /* Fix dropdown inside menu */
            .dropdown {
                margin-left: 0 !important;
                width: 100%;
                text-align: center;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .dropdown-content {
                position: static; 
                background: transparent;
                box-shadow: none;
                border: none;
                padding-left: 0;
                display: none; /* Hide by default on mobile */
                text-align: center;
                width: 100%;
                flex-direction: column;
                gap: 5px;
            }
            
            .dropdown-content.show {
                display: flex; /* Show when toggled */
            }
            
            .dropdown-content a {
                padding: 10px;
                color: var(--text-muted);
                font-size: 14px;
            }

            #nav-auth, #nav-public {
                margin-left: 0 !important;
                margin-top: 20px;
                flex-direction: column;
                width: 100% !important;
                display: flex !important;
                justify-content: center;
            }

            .cta-button {
                padding: 12px 40px;
                font-size: 15px;
                width: 80%;
                margin: 10px auto;
                display: block;
                text-align: center;
            }
            
             /* Hero adjustments */
            .hero {
                height: auto;
                min-height: 100vh;
                padding: 120px 20px 60px 20px;
            }

            .hero h1 {
                font-size: 28px; /* Reduced from 32px */
            }

            .hero p {
                font-size: 14px; /* Reduced from 16px */
                margin-bottom: 30px;
            }

            .theme-toggle {
                margin: 20px 0 0 0;
                font-size: 24px;
            }
            
            /* Specific fix for the nav-public link container margin */
            #nav-public a {
                margin-left: 0 !important;
            }
            
            /* --- Mobile Chart Header Centering --- */
            .chart-header {
                flex-direction: column;
                justify-content: center;
                align-items: center;
                gap: 20px;
                text-align: center;
            }
            
            .chart-title-group {
                display: flex; /* Ensure flex is active */
                flex-direction: column; /* Stack vertically for perfect centering */
                justify-content: center;
                align-items: center;
                width: 100%;
                text-align: center;
                gap: 5px; /* Space between Ticker and Price */
                margin-bottom: 5px;
            }
            
            .search-container {
                width: 100%;
                margin: 0;
            }
            
            .controls {
                display: flex; /* Ensure flex is active */
                margin-left: 0; 
                justify-content: center;
                align-items: center;
                width: 100%;
                gap: 15px; /* Adjust gap */
                flex-wrap: wrap; 
            }
            
            .control-group {
                align-items: center; 
                display: flex;
                flex-direction: column;
            }
            
            .control-label {
                text-align: center;
                width: 100%; /* Ensure label takes full width of group */
            }

            /* Dashboard adjustments */
            #dashboard {
                height: auto !important;
                overflow: visible !important;
                display: block !important;
            }

            .main-container {
                flex-direction: column;
                height: auto !important;
                padding: 10px;
            }

            .chart-section {
                height: 600px; /* Fixed height for chart on mobile */
                flex: none;
                width: 100%;
                margin-bottom: 20px;
            }
            
            /* Removed conflicting duplicate styles for chart-header and controls */
            
            .control-group {
                flex: 1;
                min-width: 80px;
            }

            /* Sidebar adjustments */
            .sidebar {
                width: 100%;
                height: 500px; /* Fixed height for list on mobile */
                flex: none;
            }
            
            .asset-list {
                max-height: 400px;
            }

            /* Destaques (Movers) adjustments */
            #destaques {
                padding: 20px;
                margin-top: 0;
            }

            .destaques-grid {
                grid-template-columns: 1fr; /* Stack columns */
            }
            
            .destaques-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .destaques-header select {
                width: 100% !important;
            }

            /* Market Heatmap adjustments */
            #mercado {
                padding-top: 20px;
                padding-bottom: 40px;
            }
            
            .heatmap-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .heatmap-header select {
                width: 100% !important;
            }

            /* --- Header Logo & Hamburger Restored --- */
            header {
                justify-content: space-between; /* Logo Left */
                padding: 0 20px;
            }
            
            .logo img {
                margin-left: 0 !important;
            }

            .mobile-menu-btn {
                position: absolute; /* Keep absolute/right */
                right: 20px;
                top: 50%;
                transform: translateY(-50%);
            }
            
            /* Ensure Entrar button area is strictly centered */
            #nav-public {
                width: 100% !important;
                justify-content: center !important;
                margin-left: 0 !important;
                padding: 0 !important;
            }
            
            #nav-public .cta-button {
                margin: 10px auto !important;
            }

            /* Center search placeholder/text */
            #asset-search {
                text-align: center;
            }

            #heatmap-plot {
                height: 400px !important;
            }
            
            .multiselect-container {
                 width: 100%;
            }
        }

        
        /* Sidebar Restored Styles */
        .sidebar {
            width: 250px;
            background-color: var(--bg-panel);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border-radius: 12px;
            /* margin removed, using gap */
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none; /* Hide on mobile for now or stack */
            }
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">
            <img src="static/logo.png" alt="FinSense"
                style="height: 160px; margin-top: -50px; margin-bottom: -50px; margin-left: -40px; vertical-align: middle;">
        </div>

        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <nav id="main-nav">
            <a href="index2.html" style="font-size: 16px; margin-left: 0;" data-i18n="nav_home">In√≠cio</a>

            <!-- Protected Links: Visible but intercepted if not logged in -->
            <a href="#dashboard" style="font-size: 16px;" onclick="closeMenu()" data-i18n="nav_platform">Plataforma</a>
            <a href="#mercado" style="font-size: 16px;" onclick="closeMenu()" data-i18n="nav_market">Mercado</a>

            <a href="financas" class="protected-link" onclick="closeMenu()" style="font-size: 16px;">Gest√£o de Finan√ßas</a>

            <div class="dropdown" style="margin-left: 20px;">
                <button class="nav-btn-drop" onclick="this.nextElementSibling.classList.toggle('show')"><span data-i18n="nav_analysis">An√°lise</span> ‚ñº</button>
                <div class="dropdown-content">
                    <a href="predicao" class="protected-link" onclick="closeMenu()">Modelo de Predi√ß√£o</a>
                    <a href="analise_carteiras.html" class="protected-link" onclick="closeMenu()" data-i18n="nav_risk">Correla√ß√£o & Risco</a>
                    <a href="simulacao.html" class="protected-link" onclick="closeMenu()" data-i18n="nav_simulations">Simula√ß√µes</a>
                    <a href="otimizacao.html" class="protected-link" onclick="closeMenu()" data-i18n="nav_optimization">Otimiza√ß√£o Markowitz</a>
                    <a href="portfolio.html" class="protected-link" onclick="closeMenu()" data-i18n="nav_portfolio">Gerenciar Portf√≥lio</a>
                </div>
            </div>

            <!-- Auth Section: Shows User Profile OR Login Button -->
            <div id="nav-auth" style="display: none; align-items: center; margin-left: 20px;">
                <div style="margin-left: 15px; font-size: 14px; color: rgba(255, 255, 255, 0.9);"><span data-i18n="nav_hello">Ol√°</span>, <strong
                        id="username-display">User</strong></div>
                <a href="#" id="btn-logout" class="btn-logout" onclick="logout()" data-i18n="nav_logout">Sair</a>
            </div>

            <div id="nav-public" style="display: flex; align-items: center; margin-left: 20px;">
                <a href="login.html" class="cta-button"
                    style="padding: 8px 16px; font-size: 14px; margin-left: 15px;" data-i18n="nav_login_reg">Entrar / Registrar</a>
            </div>

            <button id="theme-btn" class="theme-toggle" onclick="toggleTheme()" title="Alternar Tema"
                style="margin-left: 15px;">üåô</button>
            <button id="lang-toggle" class="theme-toggle" onclick="toggleLanguage()" title="Switch Language" style="margin-left: 10px;"><span style="font-weight:700; font-size:14px;">EN</span></button>
        </nav>
    </header>

    <script>
        function toggleMenu() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
        }
        
        function closeMenu() {
            const nav = document.getElementById('main-nav');
            if(window.innerWidth <= 768) {
                nav.classList.remove('active');
            }
        }
    </script>

    <!-- Hero Section -->
    <section class="hero">
        <canvas id="hero-particles"></canvas>
        <h1><span data-i18n="hero_title_part1">O futuro das finan√ßas</span> <br><span class="text-blue-highlight" data-i18n="hero_title_part2">precisa de clareza.</span></h1>
        <p data-i18n="hero_subtitle">Monitore o mercado global em tempo real com a precis√£o que voc√™ precisa para tomar as melhores decis√µes.</p>
        <a href="#dashboard" class="cta-button" data-i18n="hero_cta">Acessar Plataforma</a>
        <a href="#dashboard" class="scroll-indicator" style="text-decoration: none; color: rgba(255,255,255,0.5);">‚Üì</a>
    </section>

    <!-- Dashboard Section -->
    <section id="dashboard">
        <div class="dashboard-header">
            <div class="dashboard-title" data-i18n="dash_title">FinSense Dashboard</div>
        </div>

        <div class="main-container">

            <!-- Chart Section (Left) -->
            <div class="chart-section">
                <div class="chart-header">
                    <div class="chart-title-group">
                        <span id="titulo-ativo" class="chart-title">BTC-USD</span>
                        <span id="preco" class="price-display">---</span>
                        <div id="chart-spinner" class="spinner"></div>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="search-container">
                        <input type="text" id="asset-search" placeholder="Buscar ativo (ex: PETR4)..." autocomplete="off" data-i18n="search_placeholder">
                        <ul id="suggestions"></ul>
                    </div>

                    <div class="controls">
                        <div class="control-group">
                            <label class="control-label" data-i18n="controls_candles">Quantidade de Velas</label>
                            <select id="seletor-periodo" onchange="mudouAtivo()">
                                <option value="1d" data-i18n="tf_1d">1 Dia</option>
                                <option value="5d" data-i18n="tf_5d">5 Dias</option>
                                <option value="1mo" data-i18n="tf_1m">1 M√™s</option>
                                <option value="3mo" data-i18n="tf_3m">3 Meses</option>
                                <option value="6mo" data-i18n="tf_6m">6 Meses</option>
                                <option value="1y" selected data-i18n="tf_1y">1 Ano</option>
                                <option value="max" data-i18n="tf_max">M√°x</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="control-label" data-i18n="controls_time">Tempo</label>
                            <select id="seletor-intervalo" onchange="mudouAtivo()">
                                <option value="15m" data-i18n="tf_15m">15 Min</option>
                                <option value="30m" data-i18n="tf_30m">30 Min</option>
                                <option value="1h" data-i18n="tf_1h">1 Hora</option>
                                <option value="1d" selected data-i18n="tf_1d">1 Dia</option>
                                <option value="1wk" data-i18n="tf_1w">1 Sem</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="control-label" data-i18n="controls_indicators">Indicadores</label>
                            <div class="multiselect-container">
                                <button class="multiselect-btn" onclick="toggleMultiselect()" data-i18n="controls_select">Selecionar...</button>
                                <div id="multiselect-menu" class="multiselect-menu">
                                    <div class="multiselect-item" onclick="toggleCheck('check-ma')">
                                        <input type="checkbox" id="check-ma" checked onchange="mudouAtivo()">
                                        <label data-i18n="controls_ma">M√©dia M√≥vel</label>
                                        <input type="number" id="input-ma" value="14" min="1" max="200"
                                            onchange="mudouAtivo()" onclick="event.stopPropagation()"
                                            style="width: 50px; padding: 2px 5px; font-size: 12px; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-main); color: var(--text-main);">
                                    </div>
                                    <div class="multiselect-item" onclick="toggleCheck('check-rsi')">
                                        <input type="checkbox" id="check-rsi" onchange="mudouAtivo()">
                                        <label data-i18n="controls_rsi">RSI</label>
                                    </div>
                                    <div class="multiselect-item" onclick="toggleCheck('check-macd')">
                                        <input type="checkbox" id="check-macd" onchange="mudouAtivo()">
                                        <label data-i18n="controls_macd">MACD</label>
                                    </div>
                                    <div class="multiselect-item" onclick="toggleCheck('check-stoch')">
                                        <input type="checkbox" id="check-stoch" onchange="mudouAtivo()">
                                        <label data-i18n="controls_stoch">Estoc√°stico</label>
                                    </div>
                                    <div class="multiselect-item" onclick="toggleCheck('check-vol')">
                                        <input type="checkbox" id="check-vol" onchange="mudouAtivo()">
                                        <label data-i18n="controls_vol">Volume</label>
                                    </div>
                                    <div class="multiselect-item" onclick="toggleCheck('check-atr')">
                                        <input type="checkbox" id="check-atr" onchange="mudouAtivo()">
                                        <label data-i18n="controls_atr">ATR</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="grafico" style="width: 100%; flex: 1; min-height: 0;"></div>
            </div>

            <!-- Sidebar Restored (Right) -->
            <div class="sidebar">
                <div class="sidebar-header" style="padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                    <!-- Removed title "Ativos" to make room for full width select or keep it small? 
                         Image shows "Criptomoedas" taking up space. Let's use the custom-select style. 
                         User image shows basically just the dropdown in the header or below title?
                         Let's put the select inside. -->
                     <select id="sidebar-category" onchange="filterSidebar()" class="custom-select" style="width: 100%; padding: 8px;">
                        <option value="cripto" selected data-i18n="cat_crypto">Criptomoedas</option>
                        <option value="br" data-i18n="cat_br">A√ß√µes Brasil</option>
                        <option value="us" data-i18n="cat_us">A√ß√µes EUA</option>
                        <option value="indices" data-i18n="cat_indices">√çndices</option>
                        <option value="all" data-i18n="cat_all">Todos</option>
                    </select>
                </div>
                <ul id="lista-ativos-lateral" class="asset-list">
                    <!-- JS Populated -->
                </ul>
            </div>

            <!-- Sidebar (Right) REMOVED -->
        </div>
    </section>

    <!-- Destaques do Mercado Section -->
    <section id="destaques">
        <div class="destaques-header">
            <span class="section-title" data-i18n="movers_title">Destaques do Mercado</span>
            <select id="mover-category-select" onchange="loadMarketMovers()" class="custom-select"
                style="width: 200px;">
                <option value="all" data-i18n="cat_all_cats">Todas as Categorias</option>
                <option value="cripto" selected data-i18n="cat_crypto">Criptomoedas</option>
                <option value="br" data-i18n="cat_br">A√ß√µes Brasil</option>
                <option value="us" data-i18n="cat_us">A√ß√µes EUA</option>
                <option value="indices" data-i18n="cat_indices_global">√çndices Globais</option>
            </select>
        </div>
        <div class="destaques-grid">
            <div class="mover-card">
                <h3
                    style="margin-top: 0; margin-bottom: 15px; font-size: 16px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;" data-i18n="movers_gainers">
                    Maiores Altas (Top 5)</h3>
                <ul id="gainers-list" class="mover-list">
                    <li class="mover-item"><span class="mover-symbol" data-i18n="movers_loading">Carregando...</span></li>
                </ul>
            </div>
            <div class="mover-card">
                <h3
                    style="margin-top: 0; margin-bottom: 15px; font-size: 16px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;" data-i18n="movers_losers">
                    Maiores Baixas (Top 5)</h3>
                <ul id="losers-list" class="mover-list">
                    <li class="mover-item"><span class="mover-symbol" data-i18n="movers_loading">Carregando...</span></li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Market Section (Heatmap) -->
    <section id="mercado">
        <div class="market-container">
            <div class="heatmap-container">
                <div id="heatmap-loader" class="heatmap-loading">
                    <div class="spinner active"></div>
                    <span style="margin-left: 10px; font-weight: 600; color: var(--text-main);" data-i18n="heatmap_loading">Carregando
                        Mercado...</span>
                </div>
                <div class="heatmap-header">
                    <span class="section-title" data-i18n="heatmap_title">Mapa de Mercado</span>
                    <select id="heatmap-category" onchange="carregarHeatmap()" class="custom-select"
                        style="width: 200px;">
                        <option value="cripto" selected data-i18n="cat_crypto">Criptomoedas</option>
                        <option value="br" data-i18n="cat_br">A√ß√µes Brasil</option>
                        <option value="us" data-i18n="cat_us">A√ß√µes EUA</option>
                        <option value="indices" data-i18n="cat_indices_global">√çndices Globais</option>
                    </select>
                </div>

                <!-- Plotly Treemap Container -->
                <div id="heatmap-plot" style="width: 100%; height: 600px;"></div>
            </div>
        </div>
    </section>

    <!-- Hidden Input for State -->
    <input type="hidden" id="ativo-atual" value="BTC-USD">

    <!-- Custom Login Modal -->
    <div id="login-modal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <h3 style="margin-bottom: 10px; color: var(--text-main);" data-i18n="modal_title">üîí Acesso Restrito</h3>
            <p style="color: var(--text-muted); margin-bottom: 20px;" data-i18n="modal_body">Voc√™ precisa estar logado para acessar os recursos
                avan√ßados da plataforma.</p>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeModal()" class="btn-cancel" data-i18n="modal_cancel">Cancelar</button>
                <a href="login.html" class="cta-button" style="text-decoration: none; padding: 10px 20px;" data-i18n="modal_login">Fazer
                    Login</a>
            </div>
        </div>
    </div>

    <!-- Modal Styles -->
    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }

        .modal-content {
            background: var(--bg-panel);
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
            transform: translateY(20px);
            animation: slideUp 0.3s forwards;
        }

        .btn-cancel {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
        }

        .btn-cancel:hover {
            border-color: var(--text-main);
            color: var(--text-main);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
            }
        }
    </style>

    <script src="static/js/particles.js"></script>

    <script>
        // --- API Base URL Logic ---
        function getBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            // Development with Live Server (usually port 5500)
            if ((hostname === '127.0.0.1' || hostname === 'localhost') && port !== '5000') {
                return 'http://127.0.0.1:5000';
            }
            // Production or Flask Server (port 5000)
            return '';
        }
        const API_BASE_URL = getBaseUrl();

        // Modal Functions
        function showModal() {
            const modal = document.getElementById('login-modal');
            if (modal) modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('login-modal');
            if (modal) modal.style.display = 'none';
        }

        // --- AUTH LOGIC ---
        let isUserAuthenticated = false;

        async function checkAuth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/me`);
                if (response.ok) {
                    const data = await response.json();

                    if (data.authenticated) {
                        isUserAuthenticated = true;
                        document.getElementById('nav-public').style.display = 'none';
                        document.getElementById('nav-auth').style.display = 'flex';
                        document.getElementById('username-display').textContent = data.username;
                        return;
                    }
                }
            } catch (e) {
                console.log("Auth check failed:", e);
            }
            // Default: Show Public
            isUserAuthenticated = false;
            document.getElementById('nav-public').style.display = 'flex';
            document.getElementById('nav-auth').style.display = 'none';
        }

        async function logout() {
            try {
                await fetch(`${API_BASE_URL}/logout`);
                window.location.href = 'index2.html';
            } catch (e) {
                console.error("Logout failed", e);
                window.location.href = 'index2.html';
            }
        }

        // Intercept Protected Links with Modal
        document.addEventListener('DOMContentLoaded', () => {
            const protectedLinks = document.querySelectorAll('.protected-link');
            protectedLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    if (!isUserAuthenticated) {
                        e.preventDefault();
                        showModal();
                    }
                });
            });

            // Close modal on outside click
            document.getElementById('login-modal')?.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) closeModal();
            });
        });



        // Init
        checkAuth();

        // --- API Config (Auth Logic handled above) ---
        // ------------------

        // --- Configura√ß√£o Plotly (Dynamic Theme) ---
        const plotConfig = { responsive: true, displayModeBar: false, locale: 'pt-BR' };

        function getPlotLayout() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const bgColor = isDark ? '#112240' : '#ffffff';
            const gridColor = isDark ? '#233554' : '#e0e0e0';
            const textColor = isDark ? '#e6f1ff' : '#1a1a1a';

            return {
                paper_bgcolor: bgColor,
                plot_bgcolor: bgColor,
                font: { color: textColor, family: 'Manrope, sans-serif' },
                margin: { t: 30, l: 60, r: 40, b: 60 },
                xaxis: {
                    gridcolor: gridColor,
                    // tickangle: -30, // Let Plotly handle angle
                    automargin: true
                },
                yaxis: {
                    gridcolor: gridColor,
                    autorange: true,
                    fixedrange: false
                }
            };
        }


        // --- Theme Logic ---
        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);

            // Update button icon
            const btn = document.getElementById('theme-btn');
            btn.innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';

            // Refresh chart to apply new theme
            mudouAtivo();
            carregarHeatmap();
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerText = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        function toggleSpinner(id, show) {
            const el = document.getElementById(id);
            if (el) {
                if (show) el.classList.add('active');
                else el.classList.remove('active');
            }
        }

        // --- Multiselect Logic ---
        function toggleMultiselect() {
            const menu = document.getElementById('multiselect-menu');
            menu.classList.toggle('active');
        }

        // Helper to toggle checkbox when clicking the row
        function toggleCheck(id) {
            // Prevent double toggle if clicking the checkbox itself
            if (event.target.type === 'checkbox') return;

            const check = document.getElementById(id);
            check.checked = !check.checked;
            mudouAtivo();
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const container = document.querySelector('.multiselect-container');
            const menu = document.getElementById('multiselect-menu');
            if (container && !container.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // --- Search & Autocomplete Logic ---
        let allAssets = [];

        async function fetchAssets() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/assets`);
                if (response.ok) {
                    allAssets = await response.json();
                    filterSidebar(); // Initial render with default filter
                }
            } catch (e) {
                console.error("Error loading assets:", e);
            }
        }

        async function filterSidebar() {
            const categoryObj = document.getElementById('sidebar-category');
            if(!categoryObj) return;

            const category = categoryObj.value;
            const list = document.getElementById('lista-ativos-lateral'); // To show loading

            if (category === 'all') {
                // 'All' is too heavy to fetch live prices for everything at once in this architecture
                // Show static list (prices will be '---')
                renderSidebarList(allAssets);
                return;
            }

            // Show loading in sidebar
            if (list) {
                const loadingText = (window.translations && window.translations[currentLang] && window.translations[currentLang].sidebar_loading) 
                                   ? window.translations[currentLang].sidebar_loading 
                                   : 'Carregando pre√ßos...';
                list.innerHTML = `<li style="padding:20px; text-align:center; color:var(--text-muted);">${loadingText}</li>`;
            }

            try {
                // Use heatmap endpoint which returns [{symbol, name, price, change, ...}]
                const response = await fetch(`${API_BASE_URL}/api/heatmap?type=${category}`);
                if (response.ok) {
                    const data = await response.json();
                    renderSidebarList(data);
                } else {
                    // Fallback to static if error
                    console.error("Error fetching live sidebar data");
                    // Filter static list as fallback
                    const filtered = allAssets.filter(asset => (asset.category || '') === category);
                    renderSidebarList(filtered); 
                }
            } catch (e) {
                console.error("Fetch error:", e);
                // Fallback
                const filtered = allAssets.filter(asset => (asset.category || '') === category);
                renderSidebarList(filtered);
            }
        }
        
        function renderSidebarList(assets) {
            const list = document.getElementById('lista-ativos-lateral');
            if (!list) return;
            list.innerHTML = '';
            
            assets.forEach(asset => {
                const li = document.createElement('li');
                li.className = 'asset-item';
                li.onclick = () => selecionarAtivo(asset.symbol, li);
                if (asset.symbol === document.getElementById('ativo-atual').value) {
                    li.classList.add('active');
                }
                
                // Hax: price might be missing from /api/assets
                const price = asset.price !== undefined ? asset.price : 0;
                const change = asset.change !== undefined ? asset.change : 0;
                
                const isPositive = change >= 0;
                const changeClass = isPositive ? 'positive' : 'negative';
                const sign = isPositive ? '+' : '';
                
                const priceStr = asset.price !== undefined ? `$${price.toFixed(2)}` : '---';
                const changeStr = asset.change !== undefined ? `${sign}${change.toFixed(2)}%` : '---';
                
                li.innerHTML = `
                    <div class="asset-info">
                        <span class="asset-symbol">${asset.symbol}</span>
                        <span class="asset-name">${asset.name || asset.symbol}</span>
                    </div>
                    <div class="asset-price-info">
                        <div class="asset-price">${priceStr}</div>
                        <div class="asset-change ${changeClass}">${changeStr}</div>
                    </div>
                `;
                list.appendChild(li);
            });
        }

        function setupAutocomplete() {
            const input = document.getElementById('asset-search');
            const suggestions = document.getElementById('suggestions');

            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();

                if (query.length < 1) {
                    suggestions.style.display = 'none';
                    return;
                }

                const matches = allAssets.filter(asset =>
                    (asset.symbol && asset.symbol.toLowerCase().includes(query)) ||
                    (asset.name && asset.name.toLowerCase().includes(query))
                ).slice(0, 10);

                renderSuggestions(matches);
            });

            // Hide on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }

        function renderSuggestions(matches) {
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';

            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            matches.forEach(asset => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span><strong>${asset.symbol}</strong> - ${asset.name}</span>
                    <span style="font-size: 11px; opacity: 0.7; text-transform: uppercase;">${asset.category}</span>
                `;

                li.onclick = () => {
                    selecionarAtivo(asset.symbol, null);
                    suggestions.style.display = 'none';
                    document.getElementById('asset-search').value = '';
                };

                suggestions.appendChild(li);
            });

            suggestions.style.display = 'block';
        }

        function selecionarAtivo(ticker, elementoDOM) {
            document.getElementById('ativo-atual').value = ticker;

            document.querySelectorAll('.asset-item').forEach(el => el.classList.remove('active'));
            if (elementoDOM) elementoDOM.classList.add('active');

            mudouAtivo();
        }

        // --- Heatmap (Plotly Treemap) Logic ---
        async function carregarHeatmap() {
            const loader = document.getElementById('heatmap-loader');

            // Show loader
            if (loader) loader.classList.add('active');

            try {
                const categoria = document.getElementById('heatmap-category').value;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout for Render Free Tier

                const response = await fetch(`${API_BASE_URL}/api/heatmap?type=${categoria}`, { signal: controller.signal });
                clearTimeout(timeoutId);

                const dados = await response.json();

                if (!dados || dados.length === 0) {
                    document.getElementById('heatmap-plot').innerHTML = '<div style="text-align: center; padding: 50px; color: var(--text-muted);">Sem dados dispon√≠veis</div>';
                    return;
                }

                // Prepare data for Treemap
                const labels = [];
                const parents = [];
                const values = []; // Size (abs change)
                const texts = [];  // Display text
                const colors = []; // Colors based on change

                const categoryNames = {
                    'cripto': 'Criptomoedas',
                    'br': 'A√ß√µes Brasil',
                    'us': 'A√ß√µes EUA',
                    'indices': '√çndices Globais'
                };
                const rootLabel = categoryNames[categoria] || "Mercado";

                dados.forEach(ativo => {
                    labels.push(ativo.symbol);
                    parents.push(rootLabel); // Group all under the category

                    // Size: Absolute value of change (min size 0.1 to show even small changes)
                    values.push(Math.abs(ativo.change) + 0.01);

                    const isPositive = ativo.change >= 0;
                    const changeSign = isPositive ? '+' : '';

                    let currency = "$";
                    if (ativo.symbol.endsWith('.SA') || ativo.symbol === 'BRL=X' || ativo.symbol === '^BVSP') {
                        currency = "R$";
                    }

                    // Custom text for the block
                    // Use Name from backend if available
                    const displayName = ativo.name || ativo.symbol;

                    texts.push(`<b>${displayName}</b><br><span style="font-size:0.8em">${ativo.symbol}</span><br>${currency} ${ativo.price.toFixed(2)}<br>${changeSign}${ativo.change.toFixed(2)}%`);

                    // Color logic
                    if (isPositive) {
                        // Green scale
                        colors.push('#10b981');
                    } else {
                        // Red scale
                        colors.push('#ef4444');
                    }
                });

                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = '#ffffff'; // Always white text inside blocks
                const textColors = [];

                // Populate colors for assets
                dados.forEach(() => {
                    textColors.push(textColor);
                });

                // Add Root Node
                labels.push(rootLabel);
                parents.push("");
                values.push(0);
                texts.push("");
                colors.push("transparent");

                // Color for root node label
                // If dark mode, match background (#112240) to hide it. Else white.
                if (isDark) {
                    textColors.push('#112240');
                } else {
                    textColors.push(textColor);
                }


                const data = [{
                    type: "treemap",
                    labels: labels,
                    parents: parents,
                    values: values,
                    text: texts,
                    textinfo: "text",
                    hoverinfo: "label+text+value",
                    pathbar: { visible: false }, // Hide the top bar "Mercado"
                    marker: {
                        colors: colors,
                        line: { width: 1, color: isDark ? '#112240' : '#ffffff' }
                    },
                    textfont: {
                        family: 'Manrope, sans-serif',
                        size: 14,
                        color: textColors,
                        weight: 700
                    },
                    tiling: {
                        packing: 'squarify' // 'squarify', 'binary', 'dice', 'slice', 'slice-dice', 'dice-slice'
                    }
                }];

                const layout = {
                    margin: { t: 0, l: 0, r: 0, b: 0 },
                    paper_bgcolor: 'transparent',
                    font: { family: 'Manrope, sans-serif' }
                };

                Plotly.newPlot('heatmap-plot', data, layout, { responsive: true, displayModeBar: false });



            } catch (e) {
                console.error("Erro heatmap:", e);
                const errorMsg = (window.translations && window.translations[currentLang] && window.translations[currentLang].heatmap_error) 
                                 ? window.translations[currentLang].heatmap_error 
                                 : "Erro ao carregar mercado<br>Recarregue a p√°gina";
                document.getElementById('heatmap-plot').innerHTML = `<div style="text-align: center; padding: 50px; color: red; font-family: sans-serif;">${errorMsg}</div>`;
            } finally {
                // Hide loader
                if (loader) loader.classList.remove('active');
            }
        }

        // --- Chart Logic ---
        async function mudouAtivo() {
            toggleSpinner('chart-spinner', true);

            const ativoSelecionado = document.getElementById('ativo-atual').value;
            const periodo = document.getElementById('seletor-periodo').value;
            const intervalo = document.getElementById('seletor-intervalo').value;
            const maPeriod = document.getElementById('input-ma').value;
            const showRSI = document.getElementById('check-rsi').checked;
            const showMACD = document.getElementById('check-macd').checked;
            const showStoch = document.getElementById('check-stoch').checked;
            const showVol = document.getElementById('check-vol').checked;
            const showATR = document.getElementById('check-atr').checked;
            const checkMaEl = document.getElementById('check-ma');
            const showMA = checkMaEl ? checkMaEl.checked : true; // Default to true if not found

            try {
                const response = await fetch(`${API_BASE_URL}/api/dados?ticker=${ativoSelecionado}&period=${periodo}&interval=${intervalo}&ma_period=${maPeriod}`);
                if (!response.ok) throw new Error("Erro na API");
                const dados = await response.json();

                document.getElementById('titulo-ativo').innerText = dados.symbol;

                let currencySymbol = "$";
                if (dados.symbol.endsWith('.SA') || dados.symbol === 'BRL=X' || dados.symbol === '^BVSP') {
                    currencySymbol = "R$";
                }
                const precoEl = document.getElementById('preco');
                precoEl.innerText = `${currencySymbol} ${dados.preco_atual}`;

                const traces = [];

                // Main Candle Trace
                traces.push({
                    x: dados.datas,
                    close: dados.close,
                    decreasing: { line: { color: '#d32f2f', width: 1 } },
                    high: dados.high,
                    increasing: { line: { color: '#008000', width: 1 } },
                    low: dados.low,
                    open: dados.open,
                    type: 'candlestick',
                    name: (window.translations && window.translations[currentLang] && window.translations[currentLang].chart_price) || 'Pre√ßo'
                });

                // Moving Average Trace
                if (showMA) {
                    traces.push({
                        x: dados.datas,
                        y: dados.ma,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim(), width: 1.5 },
                        name: dados.ma_label
                    });
                }

                const layout = {
                    ...getPlotLayout(),
                    dragmode: 'pan',
                    showlegend: false,
                    xaxis: {
                        ...getPlotLayout().xaxis,
                        type: 'date',
                        rangeslider: { visible: false },
                        anchor: 'free',
                        position: 0
                    }
                };

                // --- Smart Tick Generation Logic ---
                // Identify target number of ticks
                const targetTicks = 8;
                const len = dados.datas.length;
                const step = Math.max(1, Math.floor(len / targetTicks));

                const tickVals = [];
                const tickText = [];

                for (let i = 0; i < len; i += step) {
                    tickVals.push(dados.datas[i]); // In category axis, the value is the category name itself (the date string)

                    // Format Label
                    const dateObj = new Date(dados.datas[i]);
                    let label = "";

                    if (periodo.includes('d') || periodo.includes('wk') || periodo.includes('mo')) {
                        // Daily/Weekly: "DD MMM" (e.g., "14 Nov")
                        const day = dateObj.getDate();
                        const month = dateObj.toLocaleDateString(currentLang === 'pt' ? 'pt-BR' : 'en-US', { month: 'short' });
                        // Remove dot from month if present
                        label = `${day} ${month.replace('.', '')}`;
                    } else if (periodo.includes('1d') || intervalo.includes('m') || intervalo.includes('h')) {
                        // Intraday: "HH:mm" (e.g., "14:30") 
                        // For longer intraday periods, might need date too
                        if (periodo === '1d' || periodo === '5d') {
                            const hours = String(dateObj.getHours()).padStart(2, '0');
                            const mins = String(dateObj.getMinutes()).padStart(2, '0');
                            const day = dateObj.getDate();
                            if (periodo === '5d') {
                                label = `${day} - ${hours}:${mins}`;
                            } else {
                                label = `${hours}:${mins}`;
                            }
                        } else {
                            // Default fallback
                            const day = dateObj.getDate();
                            const month = dateObj.toLocaleDateString(currentLang === 'pt' ? 'pt-BR' : 'en-US', { month: 'short' });
                            label = `${day} ${month.replace('.', '')}`;
                        }
                    } else {
                        // Default
                        const day = dateObj.getDate();
                        const month = dateObj.toLocaleDateString(currentLang === 'pt' ? 'pt-BR' : 'en-US', { month: 'short' });
                        label = `${day} ${month.replace('.', '')}`;
                    }
                    tickText.push(label);
                }

                // Standardize ALL charts (Crypto + Stocks) to use Category axis with CUSTOM TICKS.
                layout.xaxis.type = 'category';
                layout.xaxis.tickmode = 'array'; // Manual ticks
                layout.xaxis.tickvals = tickVals;
                layout.xaxis.ticktext = tickText;
                // layout.xaxis.nticks is ignored when tickmode is array






                // Dynamic Layout Logic for Indicators
                const indicators = [];
                if (showRSI) indicators.push('rsi');
                if (showMACD) indicators.push('macd');
                if (showStoch) indicators.push('stoch');
                if (showVol) indicators.push('vol');
                if (showATR) indicators.push('atr');

                const numIndicators = indicators.length;
                let mainDomain = [0.1, 1];

                if (numIndicators === 0) {
                    mainDomain = [0, 1];
                } else if (numIndicators === 1) {
                    mainDomain = [0.3, 1];
                } else if (numIndicators === 2) {
                    mainDomain = [0.45, 1];
                } else if (numIndicators === 3) {
                    mainDomain = [0.55, 1];
                } else if (numIndicators === 4) {
                    mainDomain = [0.60, 1];
                } else if (numIndicators === 5) {
                    mainDomain = [0.65, 1];
                }

                layout.yaxis.domain = mainDomain;

                // Helper to get domain for a specific slot index (0 = bottom)
                function getDomain(idx, total) {
                    // Simple uniform distribution for up to 5 indicators
                    // Reserved height for indicators: 1 - mainDomain[0] (approx)
                    // Wait, mainDomain starts at X. Indicators are below X.
                    // E.g. 1 indicator: Main 0.3-1. Indicator 0-0.2.
                    
                    // Let's refine for up to 5 slots
                    const slotHeight = 0.85 / Math.max(total * 1.5 + 2, 4); // Adaptive height
                    // This logic is getting complex, let's stick to the previous hardcoded style but extend it
                    
                    if (total === 5) {
                        const h = 0.10; // height per plot
                        const g = 0.03; // gap
                        const start = idx * (h + g);
                        return [start, start + h];
                    }
                    
                    if (total === 1) return [0, 0.2];
                    if (total === 2) {
                        if (idx === 0) return [0, 0.2];
                        if (idx === 1) return [0.25, 0.40];
                    }
                    if (total === 3) {
                        return [idx * 0.18, idx * 0.18 + 0.13]; // Approx logic
                    }
                    if (total === 4) {
                        return [idx * 0.14, idx * 0.14 + 0.10];
                    }
                     return [0, 0.2];
                }

                // Assign slots based on fixed priority: 
                // ATR -> Vol -> Stoch -> MACD -> RSI (Bottom to Top ?)
                // Let's map dynamically
                const activeTypes = [];
                if (showRSI) activeTypes.push('rsi');
                if (showMACD) activeTypes.push('macd');
                if (showStoch) activeTypes.push('stoch');
                if (showVol) activeTypes.push('vol');
                if (showATR) activeTypes.push('atr');
                
                // Reverse to stack from bottom up?
                // reversedTypes[0] will be at bottom slot (idx 0)
                const reversedTypes = [...activeTypes].reverse();



                // --- RSI Logic ---
                if (showRSI && dados.rsi) {
                    const slotIndex = reversedTypes.indexOf('rsi');
                    const rsiDomain = getDomain(slotIndex, numIndicators);

                    layout.yaxis2 = {
                        domain: rsiDomain,
                        range: [0, 100],
                        gridcolor: layout.yaxis.gridcolor,
                        fixedrange: true,
                        tickfont: layout.yaxis.tickfont
                    };

                    // RSI Trace
                    traces.push({
                        x: dados.datas,
                        y: dados.rsi,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#9c27b0', width: 1.5 },
                        name: 'RSI',
                        yaxis: 'y2'
                    });

                    // Overbought/Oversold Lines
                    const lineStyle = { color: 'rgba(128,128,128,0.5)', width: 1, dash: 'dash' };
                    traces.push({
                        x: [dados.datas[0], dados.datas[dados.datas.length - 1]],
                        y: [70, 70],
                        type: 'scatter',
                        mode: 'lines',
                        line: lineStyle,
                        showlegend: false,
                        hoverinfo: 'none',
                        yaxis: 'y2'
                    });
                    traces.push({
                        x: [dados.datas[0], dados.datas[dados.datas.length - 1]],
                        y: [30, 30],
                        type: 'scatter',
                        mode: 'lines',
                        line: lineStyle,
                        showlegend: false,
                        hoverinfo: 'none',
                        yaxis: 'y2'
                    });
                }




                // --- MACD Logic ---
                if (showMACD && dados.macd) {
                    const slotIndex = reversedTypes.indexOf('macd');
                    const macdDomain = getDomain(slotIndex, numIndicators);

                    // MACD Axis
                    layout.yaxis3 = {
                        domain: macdDomain,
                        gridcolor: layout.yaxis.gridcolor,
                        fixedrange: true,
                        tickfont: layout.yaxis.tickfont
                    };


                    const colors = {
                        macd: '#2962FF',
                        signal: '#FF6D00',
                        histUp: '#26A69A',
                        histDown: '#EF5350'
                    };

                    // MACD Histogram
                    traces.push({
                        x: dados.datas,
                        y: dados.macd_hist,
                        type: 'bar',
                        name: 'Histograma',
                        marker: {
                            color: dados.macd_hist.map(v => v >= 0 ? colors.histUp : colors.histDown)
                        },
                        yaxis: 'y3'
                    });

                    // MACD Line
                    traces.push({
                        x: dados.datas,
                        y: dados.macd,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: colors.macd, width: 1.5 },
                        name: 'MACD',
                        yaxis: 'y3'
                    });

                    // Signal Line
                    traces.push({
                        x: dados.datas,
                        y: dados.signal,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: colors.signal, width: 1.5 },
                        name: 'Sinal',
                        yaxis: 'y3'
                    });
                }

                // --- Stochastic Logic ---
                if (showStoch && dados.stoch_k) {
                    const slotIndex = reversedTypes.indexOf('stoch');
                    const stochDomain = getDomain(slotIndex, numIndicators);

                    layout.yaxis4 = {
                        domain: stochDomain,
                        gridcolor: layout.yaxis.gridcolor,
                        fixedrange: true,
                        range: [0, 100],
                        tickfont: layout.yaxis.tickfont
                    };

                    traces.push({
                        x: dados.datas,
                        y: dados.stoch_k,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#00B0FF', width: 1.5 },
                        name: '%K',
                        yaxis: 'y4'
                    });
                    traces.push({
                        x: dados.datas,
                        y: dados.stoch_d,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#FF4081', width: 1.5 },
                        name: '%D',
                        yaxis: 'y4'
                    });

                    // Bands
                    const lineStyle = { color: 'rgba(128,128,128,0.3)', width: 1, dash: 'dot' };
                    traces.push({
                        x: [dados.datas[0], dados.datas[dados.datas.length-1]], y: [80, 80], type: 'scatter', mode: 'lines', line: lineStyle, showlegend: false, hoverinfo: 'none', yaxis: 'y4'
                    });
                    traces.push({
                        x: [dados.datas[0], dados.datas[dados.datas.length-1]], y: [20, 20], type: 'scatter', mode: 'lines', line: lineStyle, showlegend: false, hoverinfo: 'none', yaxis: 'y4'
                    });
                }

                // --- Volume Logic ---
                if (showVol && dados.volume) {
                    const slotIndex = reversedTypes.indexOf('vol');
                    const volDomain = getDomain(slotIndex, numIndicators);

                    layout.yaxis5 = {
                        domain: volDomain,
                        gridcolor: layout.yaxis.gridcolor,
                        fixedrange: true,
                        tickfont: layout.yaxis.tickfont
                    };

                    const colors = dados.close.map((c, i) => {
                        if (i === 0) return '#26A69A';
                        return c >= dados.close[i - 1] ? '#26A69A' : '#EF5350';
                    });

                    traces.push({
                        x: dados.datas,
                        y: dados.volume,
                        type: 'bar',
                        name: 'Volume',
                        marker: {
                            color: colors
                        },
                        yaxis: 'y5'
                    });
                }

                // --- ATR Logic ---
                if (showATR && dados.atr) {
                    const slotIndex = reversedTypes.indexOf('atr');
                    const atrDomain = getDomain(slotIndex, numIndicators);

                    layout.yaxis6 = {
                        domain: atrDomain,
                        gridcolor: layout.yaxis.gridcolor,
                        fixedrange: true,
                        tickfont: layout.yaxis.tickfont,
                        title: { text: 'ATR', font: { size: 10, color: 'var(--text-muted)' } }
                    };

                    traces.push({
                        x: dados.datas,
                        y: dados.atr,
                        type: 'scatter',
                        mode: 'lines',
                        line: { color: '#FFD700', width: 1.5 }, // Gold color
                        name: 'ATR (14)',
                        yaxis: 'y6'
                    });
                }

                Plotly.newPlot('grafico', traces, layout, { responsive: true, displayModeBar: false, scrollZoom: true });

            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                toggleSpinner('chart-spinner', false);
            } finally {
                toggleSpinner('chart-spinner', false);
            }
        }

        // --- Market Movers Logic ---
        async function loadMarketMovers() {
            const listGainers = document.getElementById('gainers-list');
            const listLosers = document.getElementById('losers-list');

            try {
                const category = document.getElementById('mover-category-select').value;
                const response = await fetch(`${API_BASE_URL}/api/market-movers?type=${category}`);
                if (!response.ok) throw new Error("API Error");
                const data = await response.json();

                renderMoverList('gainers-list', data.gainers);
                renderMoverList('losers-list', data.losers);

            } catch (e) {
                console.error("Erro loading movers:", e);
                const retryText = (window.translations && window.translations[currentLang] && window.translations[currentLang].heatmap_error) 
                                 ? (currentLang === 'en' ? 'Reload' : 'Recarregar') 
                                 : 'Recarregar';
                const errorText = (window.translations && window.translations[currentLang] && window.translations[currentLang].error_loading) 
                                 ? window.translations[currentLang].error_loading 
                                 : 'Erro ao carregar dados.';
                                 
                const retryBtn = `<button onclick="loadMarketMovers()" style="background:none; border:none; color:var(--accent-primary); cursor:pointer; text-decoration:underline;">${retryText}</button>`;
                const errorHtml = `<li class="mover-item" style="color:var(--text-muted); justify-content:center; flex-direction:column;">
                                    <span>${errorText}</span>
                                    ${retryBtn}
                                   </li>`;

                if (listGainers) listGainers.innerHTML = errorHtml;
                if (listLosers) listLosers.innerHTML = errorHtml;
            }
        }

        function renderMoverList(elementId, items) {
            const list = document.getElementById(elementId);
            if (!list) return;
            list.innerHTML = '';

            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'mover-item';

                const changeClass = item.change >= 0 ? 'change-positive' : 'change-negative';
                const sign = item.change >= 0 ? '+' : '';

                // Name Logic: Use name if available, else symbol
                // Prioritize Name as main display
                const displayName = item.name || item.symbol;

                li.innerHTML = `
            <div style="display:flex; flex-direction:column;">
                <span class="mover-symbol" style="font-size:14px;">${displayName}</span>
                ${item.name ? `<span style="font-size:11px; color:var(--text-muted);">${item.symbol}</span>` : ''}
            </div>
            <div>
                <span class="mover-price">$${item.price.toFixed(2)}</span>
                <span class="mover-change ${changeClass}">${sign}${item.change.toFixed(2)}%</span>
            </div>
        `;
                list.appendChild(li);
            });
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();

            // Mobile specific defaults: Set chart period to 3 Months
            if (window.innerWidth <= 768) {
                const periodoSelect = document.getElementById('seletor-periodo');
                if (periodoSelect) {
                    periodoSelect.value = '3mo';
                }
            }

            fetchAssets();
            setupAutocomplete();
            carregarHeatmap();
            mudouAtivo();
            loadMarketMovers();

            setInterval(() => mudouAtivo(), 60000);
            // setInterval(() => carregarListaLateral(), 60000); // Removed
            setInterval(() => carregarHeatmap(), 60000);
            setInterval(() => loadMarketMovers(), 60000);
        });
    </script>
</body>

</html>