<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinSense - An√°lise de Carteiras</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Mode (Default) */
            --bg-main: #f0f2f5;
            --bg-panel: #f8f9fa;
            --text-main: #1a1a1a;
            --text-muted: #666666;
            --accent-primary: #0056b3;
            --accent-hover: #004494;
            --border-color: #e0e0e0;
            --success-green: #008000;
            --danger-red: #d32f2f;
            --hero-bg: #0a192f;
            --chart-bg: #ffffff;
            --chart-grid: #e0e0e0;
        }

        [data-theme="dark"] {
            /* Dark Mode */
            --bg-main: #0a192f;
            --bg-panel: #112240;
            --text-main: #e6f1ff;
            --text-muted: #8892b0;
            --accent-primary: #4da3ff;
            --accent-hover: #2d89ef;
            --border-color: #233554;
            --success-green: #64ffda;
            --danger-red: #ff5f56;
            --hero-bg: #020c1b;
            --chart-bg: #112240;
            --chart-grid: #233554;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background-color: var(--bg-main);
            color: var(--text-main);
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- Header --- */
        header {
            background-color: var(--hero-bg);
            padding: 0 40px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            width: 100%;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-weight: 700;
            font-size: 22px;
            color: white;
        }

        nav a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            margin-left: 30px;
            font-weight: 500;
            transition: color 0.2s;
        }

        nav a:hover {
            color: white;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 16px;
            margin-left: 12px;
            width: 50px; /* Slim Pill Width */
            height: 32px; /* Slim Pill Height */
            border-radius: 16px; /* Pill Radius */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .theme-toggle:active {
            transform: translateY(0);
        }

        .btn-logout {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            margin-left: 20px;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.2s;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .btn-logout:hover {
            color: #ff5f56; /* Danger red */
            background: rgba(255, 95, 86, 0.1);
        }

        /* --- Dropdown Nav --- */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: var(--bg-panel);
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            top: 100%;
        }

        .dropdown-content a {
            color: var(--text-main);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            margin-left: 0;
            font-size: 14px;
        }

        .dropdown-content a:hover {
            background-color: var(--bg-main);
            color: var(--accent-primary);
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .nav-btn-drop {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-family: inherit;
            font-size: 14px;
            font-weight: 500;
            margin-left: 30px;
            cursor: pointer;
            padding: 10px 0;
        }

        .nav-btn-drop:hover {
            color: white;
        }

        /* --- Main Content --- */
        .content-container {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 70px);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        p {
            font-size: 16px;
            color: var(--text-muted);
            line-height: 1.6;
        }

        input,
        select {
            background-color: var(--bg-main);
            color: var(--text-main);
            border: 1px solid var(--border-color);
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }

        input:focus,
        select:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(0, 86, 179, 0.1);
        }

        .card {
            background-color: var(--bg-panel);
            border-radius: 8px;
            /* Slightly reduced radius */
            padding: 30px;
            border: 1px solid var(--border-color);
            margin-top: 20px;
            /* Minimalist shadow */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
        }

        .cta-button {
            background-color: var(--accent-primary);
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .cta-button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
        }

        .cta-button.secondary {
            background-color: transparent;
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
        }

        .cta-button.secondary:hover {
            background-color: rgba(0, 86, 179, 0.05);
        }

        .asset-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background: transparent;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .asset-row:last-child {
            border-bottom: none;
        }

        .asset-row:hover {
            background: var(--bg-main);
        }

        .section-title {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            color: var(--text-muted);
            margin-bottom: 15px;
            border-left: 3px solid var(--accent-primary);
            padding-left: 10px;
            display: flex;
            align-items: center;
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            z-index: 1002;
        }

        .mobile-menu-btn span {
            display: block;
            width: 25px;
            height: 3px;
            margin: 5px 0;
            background-color: white;
            transition: 0.3s;
        }

        /* Responsive Grid Classes */
        .config-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            header {
                padding: 0 20px;
            }

            .logo img {
                height: 110px !important;
                margin-top: -30px !important;
                margin-bottom: -30px !important;
                margin-left: -20px !important;
            }

            .mobile-menu-btn {
                display: block;
            }

            /* Nav Menu - Hidden by default */
            nav {
                display: none !important;
                position: absolute;
                top: 70px;
                left: 0;
                width: 100%;
                background-color: var(--hero-bg);
                flex-direction: column;
                align-items: center !important;
                padding: 20px 0;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }

            nav.active {
                display: flex !important;
            }

            nav a, .dropdown, .theme-toggle, .btn-logout {
                margin: 10px 0 !important;
            }

            nav a { font-size: 18px !important; }
            .nav-btn-drop { font-size: 18px !important; }

            .dropdown {
                width: 100%;
                text-align: center;
                margin-left: 0 !important;
            }

            .dropdown-content {
                display: none; /* Collapsible */
                position: static;
                background: transparent;
                box-shadow: none;
                border: none;
                text-align: center;
                width: 100%;
            }

            .dropdown-content.show {
                display: block;
            }
            
            .dropdown-content a {
                color: var(--text-muted);
                padding: 10px;
                display: block;
            }

            .content-container {
                padding: 15px; /* Reduced padding */
            }

            h1 {
                font-size: 24px;
            }

            /* Stack Columns */
            .config-grid, .footer-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            /* Larger Touch Targets */
            input, select, #asset-search {
                padding: 10px;
                font-size: 13px; /* Reduced further to 13px */
                height: 38px; /* Compact height */
            }

            .asset-row {
                padding: 15px;
                background: var(--bg-main);
                margin-bottom: 10px;
                border-radius: 8px;
            }
            .asset-row span { font-size: 13px !important; }

            /* Fix Summary Text Size */
            #summary-text, .card h3 {
                font-size: 14px !important;
                line-height: 1.5 !important;
            }

            .cta-button {
                width: 100%;
                justify-content: center;
                padding: 12px;
                font-size: 14px;
            }
            
            /* Footer Stacking */
            .action-group {
                flex-direction: column;
                align-items: stretch !important;
                gap: 15px;
            }
            .action-group.bordered {
                border-left: none !important;
                border-top: 1px solid var(--border-color);
                padding-left: 0 !important;
                padding-top: 20px;
            }
            .action-group > div { padding-right: 0 !important; }
            .action-group select { width: 100% !important; margin-bottom: 10px; }
        }
    </style>
</head>

<body>

    <header>
        <div class="logo">
            <img src="static/logo.png" alt="FinSense"
                style="height: 160px; margin-top: -50px; margin-bottom: -50px; margin-left: -40px; vertical-align: middle;">
        </div>

        <button class="mobile-menu-btn" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </button>

        <nav id="main-nav" style="display: flex; align-items: center;">
            <a href="index2.html" style="font-size: 16px;" data-i18n="nav_home">In√≠cio</a>
            <a href="index2.html#dashboard" style="font-size: 16px;" data-i18n="nav_platform">Plataforma</a>
            <a href="index2.html#mercado" style="font-size: 16px;" data-i18n="nav_market">Mercado</a>

            <div class="dropdown">
                <button class="nav-btn-drop" onclick="this.nextElementSibling.classList.toggle('show')" style="color: white; font-weight: 700; font-size: 16px;"><span data-i18n="nav_analysis">An√°lise</span> ‚ñº</button>
                <div class="dropdown-content">
                    <a href="analise_carteiras.html" data-i18n="nav_risk">Correla√ß√£o & Risco</a>
                    <a href="simulacao.html">Simula√ß√µes</a>
                    <a href="portfolio.html" data-i18n="nav_portfolio">Gerenciar Portf√≥lio</a>
                </div>
            </div>

            <button id="theme-btn" class="theme-toggle" onclick="toggleTheme()" title="Alternar Tema">üåô</button>
            <button id="lang-toggle" class="theme-toggle" onclick="toggleLanguage()" title="Switch Language" style="margin-left: 10px;"><span style="font-weight:700; font-size:14px;">EN</span></button>
            <a href="#" class="btn-logout" onclick="logout()"
                style="margin-left: 0; padding: 5px 12px; border-radius: 6px; border: 1px solid rgba(255, 69, 58, 0.3); color: #ff6b6b; text-decoration: none; font-size: 14px;" data-i18n="nav_logout">Sair</a>
        </nav>
    </header>

    <div class="content-container">
        <h1 data-i18n="analysis_title">An√°lise de Carteiras</h1>
        <p style="margin-bottom: 30px;" data-i18n="analysis_subtitle">Analise a correla√ß√£o entre os ativos da sua carteira para entender melhor a
            diversifica√ß√£o e o risco.</p>

        <!-- Input & Configuration Config -->
        <div class="card" style="padding: 0; overflow: hidden;">
            <div style="padding: 30px;">
                <h2 style="font-size: 18px; margin-bottom: 25px;" data-i18n="config_title">Configura√ß√£o da Carteira</h2>

                <div class="config-grid">

                    <!-- Left Col: Assets -->
                    <div>
                        <div class="section-title" data-i18n="sel_assets">1. Sele√ß√£o de Ativos</div>

                        <div style="position: relative; margin-bottom: 15px;">
                            <input type="text" id="asset-search" placeholder="Buscar ativo (ex: PETR4)..."
                                autocomplete="off" data-i18n="search_placeholder">
                            <ul id="suggestions" style="
                                position: absolute; top: 105%; left: 0; width: 100%; 
                                background: var(--bg-panel); border: 1px solid var(--border-color); 
                                border-radius: 6px; list-style: none; max-height: 200px; 
                                overflow-y: auto; display: none; z-index: 1001; 
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 0;">
                            </ul>
                        </div>

                        <div id="asset-list"
                            style="border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; min-height: 50px;">
                            <!-- Empty State -->
                            <div id="empty-assets"
                                style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 13px;" data-i18n="no_assets">
                                Nenhum ativo selecionado.
                            </div>
                        </div>
                    </div>

                    <!-- Right Col: Period & Dates -->
                    <div>
                        <div class="section-title" data-i18n="sel_period">2. Per√≠odo da An√°lise</div>
                        <div style="display: flex; flex-direction: column; gap: 15px;">
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--text-muted);" data-i18n="date_start">In√≠cio</label>
                                <input type="date" id="start-date">
                            </div>
                            <div>
                                <label
                                    style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 5px; color: var(--text-muted);" data-i18n="date_end">Fim</label>
                                <input type="date" id="end-date">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Footer -->
            <div
                style="background-color: rgba(0,0,0,0.02); border-top: 1px solid var(--border-color); padding: 25px 30px;">
                <div class="footer-grid">

                    <!-- Correlation Action -->
                    <div class="action-group" style="display: flex; align-items: center; justify-content: space-between;">
                        <div>
                            <div style="font-weight: 700; font-size: 14px; margin-bottom: 3px;" data-i18n="risk_corr_title">Risco & Correla√ß√£o</div>
                            <div style="font-size: 12px; color: var(--text-muted);" data-i18n="risk_corr_desc">Matriz de correla√ß√£o e an√°lise de
                                diversifica√ß√£o.</div>
                        </div>
                        <button onclick="runCorrelationAnalysis()" class="cta-button secondary" data-i18n="btn_analyze">
                            Analisar
                        </button>
                    </div>

                    <!-- Benchmark Action -->
                    <div class="action-group bordered"
                        style="display: flex; align-items: center; justify-content: space-between; padding-left: 40px; border-left: 1px solid var(--border-color);">
                        <div style="flex: 1; padding-right: 15px;">
                            <div style="font-weight: 700; font-size: 14px; margin-bottom: 5px;" data-i18n="benchmark_title">Benchmark</div>
                            <select id="benchmark-select" style="padding: 6px 10px; font-size: 13px;">
                                <option value="^BVSP">Ibovespa</option>
                                <option value="^GSPC">S&P 500</option>
                                <option value="^IXIC">Nasdaq</option>
                                <option value="BTC-USD">Bitcoin</option>
                            </select>
                        </div>
                        <button onclick="runBenchmarkAnalysis()" class="cta-button" data-i18n="btn_compare">
                            Comparar
                        </button>
                    </div>

                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-msg" style="color: var(--danger-red); margin-top: 15px; display: none; font-weight: 600;"></div>

        <!-- Results Section -->
        <div id="results-area" style="display: none; margin-top: 30px;">

            <!-- Correlation Summary Card -->
            <div id="correlation-card" class="card"
                style="border-left: 5px solid var(--accent-primary); display: none;">
                <h3 style="margin-bottom: 10px;" data-i18n="res_corr_summary">Resumo da Correla√ß√£o</h3>
                <div id="summary-text"
                    style="font-size: 16px; font-weight: 500; text-align: justify; line-height: 1.6;"></div>
                <div style="margin-top: 10px; font-size: 14px; color: var(--text-muted);">
                    <span data-i18n="res_avg_corr">M√©dia de Correla√ß√£o Absoluta:</span> <span id="avg-corr-val"
                        style="font-weight: 700; color: var(--text-main);"></span>
                </div>
            </div>

            <!-- Performance Section -->
            <div id="benchmark-card" class="card" style="margin-top: 20px; display: none;">
                <h3 style="margin-bottom: 20px; font-size: 16px;" data-i18n="res_perf_comp">Compara√ß√£o de Rentabilidade: Carteira vs Benchmark
                </h3>
                <div id="performance-chart" style="width: 100%; height: 500px;"></div>
                <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted); text-align: center;" data-i18n="res_note">* A curva
                    'Minha Carteira' √© calculada com base nos pesos definidos acima.</div>

                <!-- New Summary Area -->
                <div id="benchmark-summary" style="display: none;"></div>
            </div>

        </div>

        <!-- Loading Overlay -->
        <div id="loading"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; flex-direction: column;">
            <div
                style="border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid var(--accent-primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;">
            </div>
            <span style="color: white; margin-top: 15px; font-weight: 600; font-size: 18px;" data-i18n="processing">Processando Dados...</span>
        </div>

    </div>

    <!-- Script Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-locale-pt-br-latest.js"></script>
    <script src="static/js/translations.js"></script>

    <script>

        // --- API Config ---
        function getBaseUrl() {
            const hostname = window.location.hostname;
            const port = window.location.port;
            if ((hostname === 'localhost' || hostname === '127.0.0.1') && port !== '5000') {
                return 'http://127.0.0.1:5000';
            }
            return '';
        }

        const API_BASE_URL = getBaseUrl();

        function toggleMenu() {
            const nav = document.getElementById('main-nav');
            nav.classList.toggle('active');
        }

        let allAssets = [];
        let selectedTickers = [];
        let lastAnalysisData = null;


        // Init Defaults
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();
            fetchAssets();
            setupAutocomplete();

            // Set default dates (Last 1 year)
            const today = new Date();
            const lastYear = new Date();
            lastYear.setFullYear(today.getFullYear() - 1);

            document.getElementById('end-date').valueAsDate = today;
            document.getElementById('start-date').valueAsDate = lastYear;
        });

        async function fetchAssets() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/assets`);
                if (response.ok) {
                    allAssets = await response.json();
                    console.log("Assets loaded:", allAssets.length);
                } else {
                    console.error("Failed to load assets: Server returned " + response.status);
                    document.getElementById('asset-search').placeholder = "Erro ao carregar ativos. Verifique o servidor.";
                }
            } catch (e) {
                console.error("Error loading assets:", e);
                document.getElementById('asset-search').placeholder = "Erro de conex√£o. Servidor offline?";
            }
        }

        function setupAutocomplete() {
            const input = document.getElementById('asset-search');
            const suggestions = document.getElementById('suggestions');
            const assetList = document.getElementById('asset-list'); // Use asset-list as container reference if needed, or just document

            input.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();

                if (query.length < 1) {
                    suggestions.style.display = 'none';
                    return;
                }

                const matches = allAssets.filter(asset =>
                    (asset.symbol && asset.symbol.toLowerCase().includes(query)) ||
                    (asset.name && asset.name.toLowerCase().includes(query))
                ).slice(0, 10); // Limit to 10

                renderSuggestions(matches);
            });

            // Hide on click outside
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });

            // Handle Backspace to remove last tag if input is empty
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && input.value === '' && selectedTickers.length > 0) {
                    // Remove the last added asset
                    removeTag(selectedTickers[selectedTickers.length - 1].symbol);
                }
            });
        }

        function renderSuggestions(matches) {
            const suggestions = document.getElementById('suggestions');
            suggestions.innerHTML = '';

            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }

            matches.forEach(asset => {
                const li = document.createElement('li');
                li.style.padding = '10px 15px';
                li.style.cursor = 'pointer';
                li.style.borderBottom = '1px solid var(--border-color)';
                li.style.fontSize = '14px';
                li.style.color = 'var(--text-main)';
                li.style.display = 'flex';
                li.style.justifyContent = 'space-between';

                li.innerHTML = `
                    <span><strong>${asset.symbol}</strong> - ${asset.name}</span>
                    <span style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">${asset.category}</span>
                `;

                li.onmouseover = () => li.style.backgroundColor = 'var(--bg-main)';
                li.onmouseout = () => li.style.backgroundColor = 'transparent';

                li.onclick = () => {
                    addTag(asset.symbol);
                    suggestions.style.display = 'none';
                    document.getElementById('asset-search').value = '';
                    document.getElementById('asset-search').focus();
                };

                suggestions.appendChild(li);
            });

            suggestions.style.display = 'block';
        }

        function addTag(ticker) {
            if (selectedTickers.find(t => t.symbol === ticker)) return;

            selectedTickers.push({ symbol: ticker, weight: 0 }); // Init with 0, will rebalance
            rebalanceWeights();
            renderAssetList();
        }

        function removeTag(ticker) {
            selectedTickers = selectedTickers.filter(t => t.symbol !== ticker);
            rebalanceWeights();
            renderAssetList();
        }

        function rebalanceWeights() {
            if (selectedTickers.length === 0) return;
            const w = parseFloat((100 / selectedTickers.length).toFixed(2));
            selectedTickers.forEach(t => t.weight = w);
        }

        function updateWeight(ticker, newWeight) {
            const asset = selectedTickers.find(t => t.symbol === ticker);
            if (asset) asset.weight = parseFloat(newWeight) || 0;
            // Note: We don't auto-rebalance others here to allow manual tweaking, 
            // but user should ensure sum is 100 technically. Backend normalizes anyway.
        }

        function renderAssetList() {
            const container = document.getElementById('asset-list');
            const emptyState = document.getElementById('empty-assets');

            // Clear but keep empty state if needed
            const currentRows = container.querySelectorAll('.asset-row');
            currentRows.forEach(r => r.remove());

            if (selectedTickers.length === 0) {
                if (!document.getElementById('empty-assets')) {
                    container.innerHTML = `<div id="empty-assets" style="padding: 20px; text-align: center; color: var(--text-muted); font-size: 13px;">Nenhum ativo selecionado.</div>`;
                } else {
                    emptyState.style.display = 'block';
                }
                return;
            } else {
                if (emptyState) emptyState.style.display = 'none';
            }

            selectedTickers.forEach(asset => {
                const row = document.createElement('div');
                row.className = 'asset-row';

                row.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="font-weight: 700; font-size: 14px; color: var(--text-main);">${asset.symbol}</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="display: flex; align-items: center; gap: 6px; background: rgba(0,0,0,0.03); padding: 4px 8px; border-radius: 4px;">
                            <span style="font-size: 11px; font-weight: 600; color: var(--text-muted);">PESO</span>
                            <div style="display: flex; align-items: center;">
                                <input type="number" value="${asset.weight}" onchange="updateWeight('${asset.symbol}', this.value)" 
                                style="width: 35px; padding: 0; border: none; background: transparent; text-align: right; font-weight: 700; font-size: 13px; outline: none; height: auto;">
                                <span style="font-size: 13px; font-weight: 700; color: var(--text-main); margin-left: 2px;">%</span>
                            </div>
                        </div>
                        
                        <button onclick="removeTag('${asset.symbol}')" style="background: none; border: none; color: var(--text-muted); font-size: 16px; cursor: pointer; padding: 5px; margin-left: 5px; transition: color 0.2s;">
                            &times;
                        </button>
                    </div>
                `;

                // Add hover effect for delete button
                const btn = row.querySelector('button');
                btn.onmouseover = () => btn.style.color = 'var(--danger-red)';
                btn.onmouseout = () => btn.style.color = 'var(--text-muted)';

                container.appendChild(row);
            });
        }

        async function runCorrelationAnalysis() {
            await performAnalysis('correlation');
        }

        async function runBenchmarkAnalysis() {
            await performAnalysis('benchmark');
        }

        async function performAnalysis(mode) {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const errorDiv = document.getElementById('error-msg');
            const loading = document.getElementById('loading');
            const resultsArea = document.getElementById('results-area');

            // Only hide the specific card we are running, or both if running all?
            // For simplicity, lets show the results area main container
            resultsArea.style.display = 'block';
            errorDiv.style.display = 'none';

            const trans = window.translations && window.translations[currentLang] ? window.translations[currentLang] : {};

            if (selectedTickers.length < 2 && mode === 'correlation') {
                errorDiv.innerText = trans.error_min_assets_corr || "Insira pelo menos 2 ativos para calcular correla√ß√£o.";
                errorDiv.style.display = 'block';
                return;
            }
            if (selectedTickers.length < 1 && mode === 'benchmark') {
                errorDiv.innerText = trans.error_min_assets_bench || "Insira pelo menos 1 ativo para o benchmark.";
                errorDiv.style.display = 'block';
                return;
            }

            if (!startDate || !endDate) {
                errorDiv.innerText = trans.error_select_dates || "Por favor, selecione as datas.";
                errorDiv.style.display = 'block';
                return;
            }

            loading.style.display = 'flex';

            try {
                const tickersList = selectedTickers.map(t => t.symbol);
                const weightsList = selectedTickers.map(t => t.weight / 100.0);

                if (mode === 'correlation') {
                    const response = await fetch(`${API_BASE_URL}/api/portfolio/correlation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ tickers: tickersList, start_date: startDate, end_date: endDate })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);

                    document.getElementById('correlation-card').style.display = 'block';
                    document.getElementById('correlation-card').style.display = 'block';
                    renderCorrelationText(data.avg_correlation);
                    // document.getElementById('summary-text').innerText = data.summary; // Use local generation
                    document.getElementById('avg-corr-val').innerText = data.avg_correlation.toFixed(2);
                    lastAnalysisData = { ...lastAnalysisData, corr: data };
                }

                if (mode === 'benchmark') {
                    const benchmark = document.getElementById('benchmark-select').value;
                    const response = await fetch(`${API_BASE_URL}/api/portfolio/benchmark`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tickers: tickersList,
                            weights: weightsList,
                            benchmark: benchmark,
                            start_date: startDate,
                            end_date: endDate
                        })
                    });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);

                    document.getElementById('benchmark-card').style.display = 'block';
                    renderBenchmarkChart(data);
                    lastAnalysisData = { ...lastAnalysisData, bench: data };
                }

            } catch (e) {
                const trans = window.translations && window.translations[currentLang] ? window.translations[currentLang] : {};
                const errPrefix = trans.error_prefix || "Erro: ";
                errorDiv.innerText = `${errPrefix}${e.message}`;
                errorDiv.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function renderCorrelationText(avg_corr) {
            const trans = window.translations && window.translations[currentLang] ? window.translations[currentLang] : {};
            let classification = "";
            let meaning = "";

            if (avg_corr > 0.7) {
                classification = trans.corr_high || "ALTA";
                meaning = trans.corr_desc_high || "Isso indica que seus ativos tendem a se mover na mesma dire√ß√£o, o que aumenta o risco sist√™mico da carteira. Em momentos de queda do mercado, √© prov√°vel que a maioria dos seus ativos desvalorize simultaneamente.";
            } else if (avg_corr > 0.4) {
                classification = trans.corr_mod || "MODERADA";
                meaning = trans.corr_desc_mod || "Isso indica que existe algum n√≠vel de diversifica√ß√£o, mas seus ativos ainda podem ser influenciados por movimentos gerais do mercado.";
            } else {
                classification = trans.corr_low || "BAIXA OU DESCORRELACIONADA";
                meaning = trans.corr_desc_low || "Isso significa que os ativos comportam-se de maneira independente ou at√© oposta, proporcionando uma excelente prote√ß√£o contra riscos de mercado.";
            }

            const intro1 = trans.corr_intro_1 || "O Coeficiente de Correla√ß√£o de Pearson M√©dio de";
            const intro2 = trans.corr_intro_2 || "desta carteira indica uma correla√ß√£o";

            const summary = `${intro1} ${avg_corr.toFixed(2)} ${intro2} ${classification}. ${meaning}`;
            document.getElementById('summary-text').innerText = summary;
        }

        function renderBenchmarkChart(benchData) {
            if (!benchData) return;

            const portfolio = benchData.portfolio;
            const benchmark = benchData.benchmark;
            const dates = benchData.dates;
            const benchSymbol = benchData.benchmark_symbol;

            // Map symbol to friendly name
            const benchmarkMap = {
                '^BVSP': 'Ibovespa',
                '^GSPC': 'S&P 500',
                '^IXIC': 'Nasdaq',
                'BTC-USD': 'Bitcoin'
            };
            const benchName = benchmarkMap[benchSymbol] || benchSymbol;

            // Calculate Performance
            const finalPort = portfolio[portfolio.length - 1];
            const finalBench = benchmark[benchmark.length - 1];
            const diff = finalPort - finalBench;

            // Update Summary Text
            // Update Summary Text
            const summaryDiv = document.getElementById('benchmark-summary');
            
            const trans = window.translations && window.translations[currentLang] ? window.translations[currentLang] : {};
            const txtWin = trans.bench_win || 'Sua Carteira superou o Benchmark!';
            const txtLoss = trans.bench_loss || 'O Benchmark superou sua Carteira.';
            const txtSum1 = trans.bench_summary_1 || 'No per√≠odo analisado, sua carteira rendeu';
            const txtSum2 = trans.bench_summary_2 || 'enquanto o';
            const txtSum3 = trans.bench_summary_3 || 'rendeu';
            const txtDiff = trans.bench_diff || 'Uma diferen√ßa de';

            const winner = finalPort > finalBench ? txtWin : txtLoss;
            const color = finalPort > finalBench ? 'var(--success-green)' : 'var(--danger-red)';
            const diffText = Math.abs(diff).toFixed(2) + '%';

            summaryDiv.innerHTML = `
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.03); border-radius: 8px; border-left: 4px solid ${color};">
                    <h4 style="margin-bottom: 5px; color: var(--text-main); font-size: 16px;">${winner}</h4>
                    <p style="margin: 0; font-size: 14px; color: var(--text-muted);">
                        ${txtSum1} <strong>${finalPort.toFixed(2)}%</strong>, ${txtSum2} <strong>${benchName}</strong> ${txtSum3} <strong>${finalBench.toFixed(2)}%</strong>.
                        ${txtDiff} <strong style="color: ${color}">${diff > 0 ? '+' : '-'}${diffText}</strong>.
                    </p>
                </div>
            `;
            summaryDiv.style.display = 'block';

            const traces = [];

            // Add Gradient
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const portColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary').trim();

            traces.push({
                x: dates,
                y: portfolio,
                type: 'scatter',
                mode: 'lines',
                name: trans.my_portfolio || 'Minha Carteira',
                line: { width: 3, color: portColor, shape: 'spline' },
                fill: 'tozeroy',
                fillcolor: isDark ? 'rgba(77, 163, 255, 0.1)' : 'rgba(0, 86, 179, 0.1)'
            });

            traces.push({
                x: dates,
                y: benchmark,
                type: 'scatter',
                mode: 'lines',
                name: benchName,
                line: { width: 2, color: '#ffb142' }, // Solid High Contrast Orange
                hoverinfo: 'y+name'
            });

            const isMobile = window.innerWidth <= 768;

            const layout = {
                title: { text: '' },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Manrope, sans-serif', color: getComputedStyle(document.documentElement).getPropertyValue('--text-main') },
                xaxis: {
                    showgrid: false,
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    tickfont: { size: isMobile ? 10 : 12 }
                },
                yaxis: {
                    showgrid: true,
                    gridcolor: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid'),
                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-muted'),
                    ticksuffix: '%',
                    zeroline: true,
                    zerolinecolor: getComputedStyle(document.documentElement).getPropertyValue('--border-color'),
                    tickfont: { size: isMobile ? 10 : 12 }
                },
                margin: isMobile ? { t: 10, r: 10, b: 40, l: 35 } : { t: 20, r: 20, b: 40, l: 60 },
                showlegend: true,
                legend: { 
                    orientation: 'h', 
                    y: isMobile ? -0.3 : -0.2, // Move legend down
                    font: { size: isMobile ? 10 : 12 }
                },
                hovermode: 'x unified',
                hoverlabel: {
                    bgcolor: isDark ? '#1e293b' : '#ffffff',
                    bordercolor: isDark ? '#334155' : '#e2e8f0',
                    font: { color: isDark ? '#ffffff' : '#1e293b' }
                }
            };
            
            /* Resize Container on Mobile */
            if (isMobile) {
                 document.getElementById('performance-chart').style.height = '350px'; // Slightly shorter to fit screen better? Or User said make BIGGER.
                 // Actually user said "make chart bigger". The container is 500px, which is tall.
                 // The issue is margins. Reducing margins (done above) makes the CHART AREA bigger.
                 // But let's ensure height is sufficient. 400-500 is good.
            }

            Plotly.newPlot('performance-chart', traces, layout, { responsive: true, displayModeBar: false });
        }


        async function logout() {
            try {
                await fetch(`${API_BASE_URL}/logout`);
                window.location.href = 'index2.html';
            } catch (e) {
                console.error("Logout failed", e);
                window.location.href = 'index2.html';
            }
        }

        function renderResults(corrData, benchData) {
            // Retired function in favor of renderBenchmarkChart and individual calls
        }

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';

            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);

            const btn = document.getElementById('theme-btn');
            btn.innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';

            // Re-render chart if it exists to clean up styles
            if (lastAnalysisData && lastAnalysisData.bench && document.getElementById('benchmark-card').style.display === 'block') {
                renderBenchmarkChart(lastAnalysisData.bench);
            }
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', saved);
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerText = saved === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        document.addEventListener('DOMContentLoaded', () => {
             loadTheme();
        });

        window.addEventListener('languageChanged', (e) => {
            if (lastAnalysisData.corr) {
                renderCorrelationText(lastAnalysisData.corr.avg_correlation);
            }
            if (lastAnalysisData.bench) {
                renderBenchmarkChart(lastAnalysisData.bench);
            }
        });
    </script>
</body>

</html>